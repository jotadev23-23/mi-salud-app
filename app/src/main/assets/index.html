<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a6b5a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Mi Salud">
<title>Mi Salud â€” Cuidado Personal</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Lora:ital@1&display=swap" rel="stylesheet">
<style>
:root {
  --verde:#1a6b5a;--verde2:#2d9e84;--verde-bg:#e8f5f1;
  --naranja:#e8743b;--naranja-bg:#fdf0ea;
  --azul:#2563eb;--azul2:#3b82f6;--azul-bg:#eff6ff;
  --rojo:#dc2626;--rojo-bg:#fef2f2;
  --morado:#7c3aed;--morado-bg:#f5f3ff;
  --rosa:#db2777;--rosa-bg:#fdf2f8;
  --amarillo:#d97706;--amarillo-bg:#fffbeb;
  --gris:#6b7280;--gris2:#9ca3af;--gris-bg:#f4f6f8;
  --blanco:#fff;--oscuro:#111827;--med:#374151;
  --shadow:0 4px 24px rgba(0,0,0,0.08);--shadow2:0 2px 10px rgba(0,0,0,0.06);
  --r:18px;--r2:14px;--r3:12px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Nunito',sans-serif;background:#eef2ef;min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden;position:relative}

/* â”€â”€ NAVIGATION â”€â”€ */
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:#fff;display:flex;border-top:1px solid #e5e7eb;z-index:100;padding:6px 0 14px;box-shadow:0 -4px 20px rgba(0,0,0,0.06)}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;cursor:pointer;padding:4px 0;font-family:'Nunito',sans-serif;transition:all .2s;position:relative}
.nb .ni{font-size:20px;transition:transform .2s}
.nb .nl{font-size:10px;font-weight:700;color:#9ca3af;letter-spacing:.2px}
.nb.active .nl{color:var(--verde)}
.nb.active .ni{transform:scale(1.15)}
.nb .badge{position:absolute;top:0;right:12px;background:var(--rojo);color:#fff;border-radius:20px;padding:1px 5px;font-size:9px;font-weight:800}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;padding-bottom:90px;min-height:100vh;animation:fadeIn .25s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ HEADER â”€â”€ */
.hdr{padding:48px 20px 26px;color:#fff;position:relative;overflow:hidden}
.hdr::before{content:'';position:absolute;top:-50px;right:-50px;width:180px;height:180px;background:rgba(255,255,255,.08);border-radius:50%}
.hdr::after{content:'';position:absolute;bottom:-30px;right:30px;width:110px;height:110px;background:rgba(255,255,255,.05);border-radius:50%}
.hdr h1{font-size:24px;font-weight:900;letter-spacing:-.5px;position:relative}
.hdr p{font-size:13px;opacity:.85;margin-top:2px;font-weight:600;position:relative}
.hdr-sub{font-size:12px;opacity:.65;margin-top:5px;font-style:italic;position:relative}
.hdr-verde{background:linear-gradient(135deg,var(--verde) 0%,var(--verde2) 100%)}
.hdr-naranja{background:linear-gradient(135deg,#c2500a 0%,var(--naranja) 100%)}
.hdr-azul{background:linear-gradient(135deg,#1d4ed8 0%,var(--azul2) 100%)}
.hdr-morado{background:linear-gradient(135deg,#5b21b6 0%,var(--morado) 100%)}
.hdr-rosa{background:linear-gradient(135deg,#9d174d 0%,var(--rosa) 100%)}
.hdr-rojo{background:linear-gradient(135deg,#991b1b 0%,var(--rojo) 100%)}
.hdr-teal{background:linear-gradient(135deg,#0f766e 0%,#14b8a6 100%)}

/* â”€â”€ BODY â”€â”€ */
.sb{padding:14px 14px 0}

/* â”€â”€ CARD â”€â”€ */
.card{background:#fff;border-radius:var(--r);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
.ct{font-size:15px;font-weight:800;color:var(--oscuro);margin-bottom:12px;display:flex;align-items:center;gap:7px}
.ct span{font-size:19px}

/* â”€â”€ GRID â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.scard{border-radius:14px;padding:12px 10px;text-align:center;cursor:pointer;transition:transform .15s}
.scard:active{transform:scale(.95)}
.sv{font-size:21px;font-weight:900;margin:4px 0 2px}
.sl{font-size:10px;font-weight:700;opacity:.7;line-height:1.2}
.si{font-size:24px}

/* â”€â”€ LIST ITEMS â”€â”€ */
.li{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid #f3f4f6}
.li:last-child{border-bottom:none}
.lic{flex:1;min-width:0}
.lin{font-size:14px;font-weight:800;color:var(--oscuro);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lid{font-size:12px;font-weight:600;color:var(--gris);margin-top:1px}
.lism{font-size:11px;color:var(--gris2)}
.icon-box{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}

/* â”€â”€ FORM â”€â”€ */
.fg{margin-bottom:12px}
.fl{font-size:13px;font-weight:700;color:var(--med);margin-bottom:4px;display:block}
.fi{width:100%;padding:11px 13px;border:2px solid #e5e7eb;border-radius:var(--r3);font-family:'Nunito',sans-serif;font-size:14px;font-weight:600;color:var(--oscuro);outline:none;transition:border-color .2s;background:#fff}
.fi:focus{border-color:var(--verde)}
textarea.fi{resize:vertical;min-height:70px}
select.fi{cursor:pointer}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:block;width:100%;padding:13px;border:none;border-radius:14px;font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;transition:all .2s;letter-spacing:.2px}
.btn:active{transform:scale(.97)}
.btn-g{background:var(--verde);color:#fff}
.btn-o{background:var(--naranja);color:#fff}
.btn-a{background:var(--azul);color:#fff}
.btn-m{background:var(--morado);color:#fff}
.btn-r{background:var(--rojo);color:#fff}
.btn-rose{background:var(--rosa);color:#fff}
.btn-teal{background:#0f766e;color:#fff}
.btn-sm{padding:9px 16px;border-radius:12px;font-size:13px;display:inline-block;width:auto}
.btn-outline{background:none;border:2px solid;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;cursor:pointer;border-radius:12px;padding:8px 14px;transition:all .2s}

/* â”€â”€ MODAL â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:600;backdrop-filter:blur(4px)}
.mo.open{display:flex;align-items:flex-end;justify-content:center}
.modal{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:430px;padding:20px 18px 36px;max-height:88vh;overflow-y:auto;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mh{width:38px;height:4px;background:#e5e7eb;border-radius:2px;margin:0 auto 18px}
.mt{font-size:18px;font-weight:900;color:var(--oscuro);margin-bottom:16px}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.tabs::-webkit-scrollbar{display:none}
.tab{flex-shrink:0;padding:9px 14px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;color:var(--gris)}
.tab.active{background:var(--verde);border-color:var(--verde);color:#fff}

/* â”€â”€ CHECK BTN â”€â”€ */
.cbtn{width:34px;height:34px;border-radius:50%;border:2.5px solid #e5e7eb;background:none;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.cbtn.done{background:var(--verde);border-color:var(--verde);color:#fff}

/* â”€â”€ TOGGLE â”€â”€ */
.trow{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f3f4f6}
.trow:last-child{border-bottom:none}
.tlbl{font-size:13px;font-weight:700;color:var(--med)}
.tlbl small{display:block;font-size:11px;color:var(--gris);font-weight:600}
.tog{width:44px;height:24px;background:#e5e7eb;border-radius:12px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.tog.on{background:var(--verde)}
.tog::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.tog.on::after{left:23px}

/* â”€â”€ TAGS â”€â”€ */
.tag-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.tag{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s}

/* â”€â”€ CHART â”€â”€ */
.chart-wrap{width:100%;overflow-x:auto;padding-bottom:4px}
canvas{display:block}

/* â”€â”€ URGENCIA â”€â”€ */
.urg-card{background:linear-gradient(135deg,#991b1b,var(--rojo));border-radius:var(--r);padding:16px;margin-bottom:12px;box-shadow:0 4px 20px rgba(220,38,38,.3);color:#fff}
.urg-card h3{font-size:16px;font-weight:900;margin-bottom:3px}
.urg-card p{font-size:12px;opacity:.9;margin-bottom:12px}
.urg-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.urg-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.4);color:#fff;border-radius:12px;padding:10px;font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;cursor:pointer;transition:all .2s;backdrop-filter:blur(4px)}
.urg-btn:active{transform:scale(.97)}
.urg-btn.full{grid-column:1/-1;background:#fff;color:var(--rojo);border-color:#fff}

/* â”€â”€ CARNET EMERGENCIA â”€â”€ */
.carnet{background:linear-gradient(135deg,#1e3a5f,#2563eb);border-radius:var(--r);padding:18px;color:#fff;margin-bottom:12px}
.carnet-top{display:flex;align-items:center;gap:12px;margin-bottom:14px;width:100%}
.carnet-avatar{width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0}
.carnet-name{font-size:18px;font-weight:900}
.carnet-info{font-size:12px;opacity:.8;margin-top:2px}
.carnet-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.carnet-item{background:rgba(255,255,255,.12);border-radius:10px;padding:10px}
.carnet-lbl{font-size:10px;opacity:.7;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.carnet-val{font-size:13px;font-weight:800;margin-top:3px}

/* â”€â”€ WATER TRACKER â”€â”€ */
.water-track{display:flex;align-items:center;gap:8px;margin:6px 0}
.water-glass{font-size:28px;cursor:pointer;transition:transform .15s;filter:grayscale(1);opacity:.35}
.water-glass.filled{filter:none;opacity:1;animation:pop .25s ease}
@keyframes pop{0%{transform:scale(1.4)}100%{transform:scale(1)}}

/* â”€â”€ SLEEP â”€â”€ */
.sleep-bar{height:12px;background:#e5e7eb;border-radius:6px;margin-top:8px;overflow:hidden}
.sleep-fill{height:100%;background:linear-gradient(90deg,var(--morado),var(--azul2));border-radius:6px;transition:width .5s ease}

/* â”€â”€ VITALES CHART MINI â”€â”€ */
.trend{display:flex;align-items:flex-end;gap:3px;height:40px;margin-top:8px}
.trend-bar{flex:1;background:var(--verde-bg);border-radius:3px 3px 0 0;position:relative;cursor:pointer;transition:background .2s;min-height:4px}
.trend-bar:hover{background:var(--verde2)}
.trend-bar .tip{display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--oscuro);color:#fff;padding:3px 7px;border-radius:6px;font-size:10px;white-space:nowrap;margin-bottom:3px}
.trend-bar:hover .tip{display:block}

/* â”€â”€ ALARM BANNER â”€â”€ */
.alarm-banner{display:none;position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:var(--naranja);color:#fff;padding:14px 16px;z-index:400;animation:slDown .3s ease;box-shadow:0 4px 20px rgba(232,116,59,.5)}
.alarm-banner.show{display:flex;align-items:center;gap:10px}
@keyframes slDown{from{transform:translateX(-50%) translateY(-100%)}to{transform:translateX(-50%) translateY(0)}}
.alarm-text{flex:1;font-weight:700;font-size:13px}
.alarm-close{background:rgba(255,255,255,.2);border:none;color:#fff;cursor:pointer;border-radius:50%;width:26px;height:26px;font-size:13px;display:flex;align-items:center;justify-content:center}

/* â”€â”€ PIN OVERLAY â”€â”€ */
.pin-overlay{display:none;position:fixed;inset:0;background:linear-gradient(135deg,var(--verde),var(--verde2));z-index:500;flex-direction:column;align-items:center;justify-content:center;padding:30px}
.pin-overlay.show{display:flex}
.pin-title{font-size:26px;font-weight:900;color:#fff;margin-bottom:8px;text-align:center}
.pin-sub{font-size:14px;color:rgba(255,255,255,.8);margin-bottom:32px;text-align:center}
.pin-dots{display:flex;gap:14px;margin-bottom:32px}
.pin-dot{width:18px;height:18px;border-radius:50%;border:2.5px solid rgba(255,255,255,.6);background:transparent;transition:background .2s}
.pin-dot.filled{background:#fff;border-color:#fff}
.pin-grid{display:grid;grid-template-columns:repeat(3,80px);gap:12px}
.pin-key{width:80px;height:70px;border-radius:16px;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);color:#fff;font-family:'Nunito',sans-serif;font-size:22px;font-weight:800;cursor:pointer;transition:all .15s;backdrop-filter:blur(4px)}
.pin-key:active{transform:scale(.92);background:rgba(255,255,255,.3)}
.pin-key.del{font-size:18px}
.pin-err{color:rgba(255,80,80,1);font-size:13px;font-weight:700;margin-top:16px;min-height:20px}

/* â”€â”€ PROFILE â”€â”€ */
.prof-hdr{display:flex;align-items:center;gap:14px;margin-bottom:16px}
.prof-avatar{width:66px;height:66px;border-radius:50%;background:linear-gradient(135deg,var(--verde),var(--verde2));display:flex;align-items:center;justify-content:center;font-size:32px;flex-shrink:0}
.prof-name{font-size:18px;font-weight:900;color:var(--oscuro)}
.prof-age{font-size:12px;font-weight:600;color:var(--gris);margin-top:2px}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:28px 16px;color:var(--gris)}
.empty .ei{font-size:44px;margin-bottom:10px}
.empty p{font-size:13px;font-weight:600;line-height:1.5}

/* â”€â”€ HISTORIA â”€â”€ */
.hist-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid #f3f4f6}
.hist-item:last-child{border-bottom:none}
.hist-date{font-size:11px;font-weight:700;color:var(--gris);min-width:44px;text-align:center;padding-top:2px;line-height:1.4}
.hist-c{flex:1}
.hist-t{font-size:14px;font-weight:800;color:var(--oscuro)}
.hist-d{font-size:12px;color:var(--gris);margin-top:1px}
.hist-tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;margin-top:4px}

/* â”€â”€ DIETA â”€â”€ */
.diet-item{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f3f4f6}
.diet-item:last-child{border-bottom:none}
.diet-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--oscuro);color:#fff;padding:9px 18px;border-radius:40px;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;z-index:600;white-space:nowrap;pointer-events:none;animation:fadeUp .3s ease;box-shadow:0 4px 20px rgba(0,0,0,.25)}
@keyframes fadeUp{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* â”€â”€ MISC â”€â”€ */
.divider{height:1px;background:#f3f4f6;margin:10px 0}
.row{display:flex;align-items:center;gap:8px}
.flex1{flex:1}
.text-g{color:var(--gris);font-size:12px;font-weight:600}
.bold{font-weight:800}
.mt8{margin-top:8px}
.mb12{margin-bottom:12px}
.del-btn{background:none;border:none;cursor:pointer;font-size:16px;padding:4px;color:var(--gris2);transition:color .2s}
.del-btn:hover{color:var(--rojo)}
.pill-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}
.section-lbl{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--gris2);margin:14px 0 8px 2px}
.info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f3f4f6;font-size:13px}
.info-row:last-child{border-bottom:none}
.info-lbl{color:var(--gris);font-weight:600}
.info-val{font-weight:800;color:var(--oscuro)}

/* â”€â”€ CALENDARIO â”€â”€ */
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.cal-month{font-size:17px;font-weight:900;color:var(--oscuro);text-transform:capitalize}
.cal-nav-btn{background:var(--gris-bg);border:none;border-radius:10px;width:38px;height:38px;font-size:18px;cursor:pointer;transition:all .15s;font-weight:700}
.cal-nav-btn:active{transform:scale(.9)}
.cal-grid-header{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:4px}
.cal-dow{text-align:center;font-size:10px;font-weight:800;color:var(--gris2);padding:4px 0;text-transform:uppercase}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cal-cell{position:relative;aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;transition:all .15s;font-size:13px;font-weight:700;color:var(--med);min-height:36px}
.cal-cell:active{transform:scale(.88)}
.cal-cell.other{color:var(--gris2);opacity:.35;pointer-events:none}
.cal-cell.today{background:var(--verde);color:#fff !important;font-weight:900;box-shadow:0 2px 8px rgba(26,107,90,.35)}
.cal-cell.selected{background:var(--azul-bg);border:2px solid var(--azul)}
.cal-dots{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);display:flex;gap:2px}
.cal-dot{width:4px;height:4px;border-radius:50%}
.cal-today-dot{background:rgba(255,255,255,.8) !important}
.cal-legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid #f3f4f6}
.cal-leg-item{display:flex;align-items:center;gap:4px;font-size:11px;font-weight:700;color:var(--gris)}
.cal-leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cal-events-title{font-size:13px;font-weight:900;color:var(--oscuro);margin-bottom:8px}
.cal-ev{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;margin-bottom:6px;border-left:4px solid transparent}
.cal-ev-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.cal-ev-title{font-size:13px;font-weight:800;color:var(--oscuro)}
.cal-ev-sub{font-size:11px;color:var(--gris);margin-top:1px}
.prox-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f3f4f6}
.prox-item:last-child{border-bottom:none}
.prox-badge{font-size:10px;font-weight:800;padding:3px 8px;border-radius:20px;white-space:nowrap}

/* â”€â”€ NOTIFICACIONES â”€â”€ */
.notif-badge{position:absolute;top:1px;right:8px;background:var(--rojo);color:#fff;border-radius:20px;padding:1px 5px;font-size:9px;font-weight:800;min-width:16px;text-align:center}
.notif-item{display:flex;gap:10px;padding:11px 0;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:all .15s}
.notif-item:last-child{border-bottom:none}
.notif-item:active{opacity:.7}
.notif-item.unread .notif-title{color:var(--oscuro)}
.notif-item.read .notif-title{color:var(--gris)}
.notif-item.read .notif-icon-box{opacity:.6}
.notif-icon-box{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.notif-title{font-size:13px;font-weight:800}
.notif-body{font-size:12px;color:var(--gris);margin-top:2px;line-height:1.4}
.notif-time{font-size:10px;color:var(--gris2);margin-top:3px}
.unread-indicator{width:8px;height:8px;border-radius:50%;background:var(--azul);flex-shrink:0;margin-top:4px}

/* â”€â”€ UPDATE BANNER â”€â”€ */
.update-banner{display:none;position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;z-index:500;padding:0}
.update-banner.show{display:block}
.update-inner{background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff;padding:12px 14px;display:flex;align-items:center;gap:10px;box-shadow:0 4px 24px rgba(37,99,235,.5)}
.update-text{flex:1;font-size:12px;font-weight:700;line-height:1.4}
.update-text strong{font-size:13px;display:block}
.update-action{background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.5);color:#fff;border-radius:10px;padding:7px 14px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:900;cursor:pointer;white-space:nowrap}
.update-close-btn{background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:50%;width:26px;height:26px;font-size:12px;cursor:pointer;flex-shrink:0}


/* â”€â”€ UPDATE MODAL CHANGELOG â”€â”€ */
#umCambios li{display:flex;align-items:flex-start;gap:10px;padding:9px 10px;background:var(--verde-bg);border-radius:10px;margin-bottom:6px;font-size:13px;color:var(--oscuro);font-weight:600}
#umCambios li span.um-check{font-size:16px;flex-shrink:0}

</style>
</head>
<body>

<!-- PIN OVERLAY -->
<div class="pin-overlay" id="pinOverlay">
  <div style="font-size:48px;margin-bottom:8px">ğŸ”’</div>
  <div class="pin-title">Mi Salud</div>
  <div class="pin-sub" id="pinSub">IngresÃ¡ tu PIN de seguridad</div>
  <div class="pin-dots">
    <div class="pin-dot" id="d0"></div>
    <div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div>
    <div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-grid">
    <button class="pin-key" onclick="pinKey('1')">1</button>
    <button class="pin-key" onclick="pinKey('2')">2</button>
    <button class="pin-key" onclick="pinKey('3')">3</button>
    <button class="pin-key" onclick="pinKey('4')">4</button>
    <button class="pin-key" onclick="pinKey('5')">5</button>
    <button class="pin-key" onclick="pinKey('6')">6</button>
    <button class="pin-key" onclick="pinKey('7')">7</button>
    <button class="pin-key" onclick="pinKey('8')">8</button>
    <button class="pin-key" onclick="pinKey('9')">9</button>
    <button class="pin-key" style="font-size:13px;opacity:.6" onclick="pinSkip()">Omitir</button>
    <button class="pin-key" onclick="pinKey('0')">0</button>
    <button class="pin-key del" onclick="pinDel()">âŒ«</button>
  </div>
  <div class="pin-err" id="pinErr"></div>
</div>

<!-- ALARM BANNER -->
<div class="alarm-banner" id="alarmBanner">
  <span style="font-size:22px;animation:pulse 1s infinite">ğŸ’Š</span>
  <div class="alarm-text">
    <strong id="alarmTitle">Hora del medicamento</strong><br>
    <span id="alarmSub" style="font-size:11px;opacity:.9"></span>
  </div>
  <button class="alarm-close" onclick="closeAlarm()">âœ•</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: INICIO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-inicio">
  <div class="hdr hdr-verde">
    <h1 id="greetTitle">Â¡Buen dÃ­a! ğŸ‘‹</h1>
    <p id="hdrName">Mi Salud</p>
    <div class="hdr-sub" id="hdrDate"></div>
  </div>
  <div class="sb">

    <!-- CARNET EMERGENCIA -->
    <div class="carnet" id="homeCarnet">
      <div class="carnet-top">
        <div class="carnet-avatar" id="carnetAvatar">ğŸ‘´</div>
        <div style="flex:1">
          <div class="carnet-name" id="carnetName">â€”</div>
          <div class="carnet-info" id="carnetInfo">CompletÃ¡ tu perfil</div>
        </div>
        <button id="bellBtn" onclick="goPage('notifs')" style="position:relative;background:rgba(255,255,255,0.18);border:none;border-radius:50%;width:42px;height:42px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s" ontouchstart="this.style.transform='scale(.9)'" ontouchend="this.style.transform='scale(1)'">
          ğŸ””
          <span id="notifBadge" style="display:none;position:absolute;top:2px;right:2px;background:#ef4444;color:#fff;border-radius:20px;padding:1px 5px;font-size:9px;font-weight:800;min-width:16px;text-align:center;border:1.5px solid rgba(26,107,90,.3)">0</span>
        </button>
      </div>
      <div class="carnet-grid">
        <div class="carnet-item"><div class="carnet-lbl">ğŸ©¸ Sangre</div><div class="carnet-val" id="carnetSangre">â€”</div></div>
        <div class="carnet-item"><div class="carnet-lbl">ğŸ’Š Medicamentos</div><div class="carnet-val" id="carnetMeds">â€”</div></div>
        <div class="carnet-item" style="grid-column:1/-1"><div class="carnet-lbl">âš ï¸ Alergias</div><div class="carnet-val" id="carnetAlerg">â€”</div></div>
      </div>
    </div>

    <!-- URGENCIA -->
    <div class="urg-card">
      <h3>ğŸ†˜ Emergencia</h3>
      <p>En caso de urgencia mÃ©dica</p>
      <div class="urg-btns">
        <button class="urg-btn" onclick="llamar('911')">ğŸ“ 911</button>
        <button class="urg-btn" onclick="llamarContacto()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Familiar</button>
        <button class="urg-btn full" onclick="llamarMedico()">ğŸ©º Llamar a mi MÃ©dico</button>
      </div>
    </div>

    <!-- SIGNOS VITALES -->
    <div class="card">
      <div class="ct"><span>â¤ï¸</span> Signos Vitales</div>
      <div class="g2">
        <div class="scard" style="background:var(--rojo-bg)" onclick="goPage('vitales')">
          <div class="si">ğŸ©¸</div>
          <div class="sv" style="color:var(--rojo)" id="hPA">â€”</div>
          <div class="sl" style="color:var(--rojo)">PresiÃ³n</div>
        </div>
        <div class="scard" style="background:var(--naranja-bg)" onclick="goPage('vitales')">
          <div class="si">ğŸ’“</div>
          <div class="sv" style="color:var(--naranja)" id="hFC">â€”</div>
          <div class="sl" style="color:var(--naranja)">Frecuencia</div>
        </div>
        <div class="scard" style="background:var(--azul-bg)" onclick="goPage('vitales')">
          <div class="si">ğŸŒ¡ï¸</div>
          <div class="sv" style="color:var(--azul)" id="hTemp">â€”</div>
          <div class="sl" style="color:var(--azul)">Temperatura</div>
        </div>
        <div class="scard" style="background:var(--morado-bg)" onclick="goPage('vitales')">
          <div class="si">ğŸ«</div>
          <div class="sv" style="color:var(--morado)" id="hSO2">â€”</div>
          <div class="sl" style="color:var(--morado)">SaturaciÃ³n Oâ‚‚</div>
        </div>
      </div>
    </div>

    <!-- HIDRATACION HOY -->
    <div class="card">
      <div class="ct"><span>ğŸ’§</span> HidrataciÃ³n de Hoy</div>
      <div style="font-size:13px;font-weight:600;color:var(--gris);margin-bottom:8px">TocÃ¡ cada vaso para registrar (8 vasos = 2 litros)</div>
      <div class="water-track" id="waterTrack"></div>
      <div style="font-size:13px;font-weight:700;color:var(--azul);margin-top:8px" id="waterCount">0 / 8 vasos tomados</div>
    </div>

    <!-- MEDICAMENTOS HOY -->
    <div class="card">
      <div class="ct"><span>ğŸ’Š</span> Medicamentos de Hoy</div>
      <div id="homeReminders"><div class="empty"><div class="ei">ğŸ’Š</div><p>Sin medicamentos registrados.<br>AgregÃ¡ uno en Recordatorios.</p></div></div>
    </div>

    <!-- ACTIVIDAD HOY -->
    <div class="card">
      <div class="ct"><span>ğŸƒ</span> Actividad de Hoy</div>
      <div class="g3">
        <div class="scard" style="background:var(--verde-bg)">
          <div class="si" style="font-size:20px">ğŸ‘£</div>
          <div class="sv" style="color:var(--verde);font-size:18px" id="hPasos">0</div>
          <div class="sl" style="color:var(--verde)">Pasos</div>
        </div>
        <div class="scard" style="background:var(--amarillo-bg)">
          <div class="si" style="font-size:20px">â±ï¸</div>
          <div class="sv" style="color:var(--amarillo);font-size:18px" id="hMins">0</div>
          <div class="sl" style="color:var(--amarillo)">Minutos</div>
        </div>
        <div class="scard" style="background:var(--naranja-bg)">
          <div class="si" style="font-size:20px">ğŸ”¥</div>
          <div class="sv" style="color:var(--naranja);font-size:18px" id="hCals">0</div>
          <div class="sl" style="color:var(--naranja)">Cal.</div>
        </div>
      </div>
      <button class="btn btn-g mt8" style="font-size:13px;padding:10px" onclick="openMod('modalActividad')">+ Registrar actividad</button>
    </div>

    <!-- SUEÃ‘O HOY -->
    <div class="card">
      <div class="ct"><span>ğŸ˜´</span> SueÃ±o</div>
      <div style="font-size:13px;color:var(--gris);font-weight:600" id="sleepLbl">Sin registro de anoche</div>
      <div class="sleep-bar"><div class="sleep-fill" id="sleepFill" style="width:0%"></div></div>
      <button class="btn btn-m mt8" style="font-size:13px;padding:10px" onclick="openMod('modalSueno')">+ Registrar sueÃ±o</button>
    </div>

    <!-- PRÃ“XIMOS TURNOS -->
    <div class="card">
      <div class="ct"><span>ğŸ“…</span> PrÃ³ximos Turnos</div>
      <div id="homeTurnos"><div class="empty"><div class="ei">ğŸ“…</div><p>Sin turnos agendados.</p></div></div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: RECORDATORIOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-recordatorios">
  <div class="hdr hdr-naranja">
    <h1>ğŸ’Š Medicamentos</h1>
    <p>Recordatorios y alarmas</p>
  </div>
  <div class="sb">
    <button class="btn btn-o mb12" onclick="openMod('modalMed')">+ Agregar Medicamento</button>
    <div class="card">
      <div class="ct"><span>ğŸ“‹</span> Mis Medicamentos</div>
      <div id="medList"><div class="empty"><div class="ei">ğŸ’Š</div><p>Sin medicamentos registrados.</p></div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: VITALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-vitales">
  <div class="hdr hdr-rojo">
    <h1>â¤ï¸ Signos Vitales</h1>
    <p>RegistrÃ¡ tus mediciones</p>
  </div>
  <div class="sb">
    <div class="card">
      <div class="ct"><span>ğŸ“Š</span> Registrar Ahora</div>
      <div class="g2">
        <div class="fg"><label class="fl">ğŸ©¸ PresiÃ³n (ej:120/80)</label><input class="fi" id="inPA" placeholder="120/80"></div>
        <div class="fg"><label class="fl">ğŸ’“ Frec. Card. (lpm)</label><input class="fi" id="inFC" type="number" placeholder="70"></div>
        <div class="fg"><label class="fl">ğŸŒ¡ï¸ Temperatura (Â°C)</label><input class="fi" id="inTemp" type="number" step="0.1" placeholder="36.5"></div>
        <div class="fg"><label class="fl">ğŸ« SaturaciÃ³n Oâ‚‚ (%)</label><input class="fi" id="inSO2" type="number" placeholder="98"></div>
        <div class="fg"><label class="fl">âš–ï¸ Peso (kg)</label><input class="fi" id="inPeso" type="number" step="0.1" placeholder="70"></div>
        <div class="fg"><label class="fl">ğŸ©¸ Glucosa (mg/dL)</label><input class="fi" id="inGlucosa" type="number" placeholder="100"></div>
      </div>
      <div class="fg"><label class="fl">ğŸ“ Notas</label><input class="fi" id="inVNote" placeholder="CÃ³mo te sentÃ­s hoy..."></div>
      <button class="btn btn-r" onclick="guardarVitales()">ğŸ’¾ Guardar MediciÃ³n</button>
    </div>

    <!-- GRÃFICOS -->
    <div class="card">
      <div class="ct"><span>ğŸ“ˆ</span> EvoluciÃ³n de PresiÃ³n</div>
      <div class="chart-wrap"><canvas id="chartPA" height="120"></canvas></div>
    </div>
    <div class="card">
      <div class="ct"><span>ğŸ“ˆ</span> EvoluciÃ³n de Peso</div>
      <div class="chart-wrap"><canvas id="chartPeso" height="120"></canvas></div>
    </div>
    <div class="card">
      <div class="ct"><span>ğŸ“ˆ</span> Glucosa</div>
      <div class="chart-wrap"><canvas id="chartGlucosa" height="120"></canvas></div>
    </div>

    <div class="card">
      <div class="ct"><span>ğŸ“œ</span> Historial</div>
      <div id="vitalesList"><div class="empty"><div class="ei">ğŸ“Š</div><p>Sin mediciones.</p></div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: HISTORIA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-historia">
  <div class="hdr hdr-azul">
    <h1>ğŸ¥ Historia ClÃ­nica</h1>
    <p>Consultas, diagnÃ³sticos y mÃ¡s</p>
  </div>
  <div class="sb">
    <div class="tabs" style="overflow-x:auto;white-space:nowrap;display:flex;-webkit-overflow-scrolling:touch">
      <button class="tab active" onclick="setTab('turnos-hist',this)">ğŸ“… Turnos</button>
      <button class="tab" onclick="setTab('agenda-hist',this)">ğŸ—“ï¸ Calendario</button>
      <button class="tab" onclick="setTab('consultas',this)">ğŸ¥ Consultas</button>
      <button class="tab" onclick="setTab('enfermedades',this)">ğŸ©º Enferm.</button>
      <button class="tab" onclick="setTab('alergias',this)">âš ï¸ Alergias</button>
      <button class="tab" onclick="setTab('vacunas',this)">ğŸ’‰ Vacunas</button>
      <button class="tab" onclick="setTab('dieta',this)">ğŸ½ï¸ Dieta</button>
    </div>

    <!-- TAB: TURNOS -->
    <div id="tab-turnos-hist">
      <button class="btn btn-azul mb12" style="background:var(--azul);color:#fff" onclick="openMod('modalTurno')">+ Agendar Turno</button>
      <div class="card"><div id="turnosListHist"><div class="empty"><div class="ei">ğŸ“…</div><p>Sin turnos agendados.</p></div></div></div>
    </div>

    <!-- TAB: CALENDARIO/AGENDA -->
    <div id="tab-agenda-hist" style="display:none">
      <div class="card">
        <div class="cal-nav">
          <button class="cal-nav-btn" onclick="calNavMesHist(-1)">â€¹</button>
          <span class="cal-month" id="calMonthLabelHist">â€”</span>
          <button class="cal-nav-btn" onclick="calNavMesHist(1)">â€º</button>
        </div>
        <div class="cal-grid-header" id="calDowHist"></div>
        <div class="cal-grid" id="calGridHist"></div>
        <div class="cal-legend">
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--naranja)"></div>Medicamento</div>
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--azul)"></div>Turno</div>
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--morado)"></div>Consulta</div>
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--verde)"></div>Vacuna</div>
        </div>
      </div>
      <div class="card" id="calDiaCardHist" style="display:none">
        <div class="cal-events-title" id="calDiaLabelHist">ğŸ“‹ Eventos del dÃ­a</div>
        <div id="calDiaEventosHist"></div>
      </div>
      <div class="card">
        <div class="ct"><span>ğŸ”œ</span> PrÃ³ximos 30 dÃ­as</div>
        <div id="calProximosHist"><div class="empty"><div class="ei">ğŸ“…</div><p>Sin eventos prÃ³ximos</p></div></div>
      </div>
    </div>

    <!-- TAB: CONSULTAS -->
    <div id="tab-consultas" style="display:none">
      <button class="btn btn-a mb12" onclick="openMod('modalConsulta')">+ Nueva Consulta</button>
      <div class="card"><div id="consultasList"><div class="empty"><div class="ei">ğŸ¥</div><p>Sin consultas.</p></div></div></div>
    </div>
    <div id="tab-enfermedades" style="display:none">
      <button class="btn btn-a mb12" onclick="openMod('modalEnfermedad')">+ Agregar CondiciÃ³n</button>
      <div class="card"><div id="enfermedadesList"><div class="empty"><div class="ei">ğŸ©º</div><p>Sin condiciones.</p></div></div></div>
    </div>
    <div id="tab-alergias" style="display:none">
      <button class="btn btn-a mb12" onclick="openMod('modalAlergia')">+ Agregar Alergia</button>
      <div class="card"><div id="alergiasList"><div class="empty"><div class="ei">âš ï¸</div><p>Sin alergias.</p></div></div></div>
    </div>
    <div id="tab-vacunas" style="display:none">
      <button class="btn btn-a mb12" onclick="openMod('modalVacuna')">+ Agregar Vacuna</button>
      <div class="card"><div id="vacunasList"><div class="empty"><div class="ei">ğŸ’‰</div><p>Sin vacunas registradas.</p></div></div></div>
    </div>
    <div id="tab-dieta" style="display:none">
      <button class="btn btn-a mb12" onclick="openMod('modalDieta')">+ Agregar RestricciÃ³n</button>
      <div class="card">
        <div class="ct"><span>ğŸ½ï¸</span> Restricciones Alimentarias</div>
        <div id="dietaList"><div class="empty"><div class="ei">ğŸ½ï¸</div><p>Sin restricciones registradas.</p></div></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: MÃS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-mas">
  <div class="hdr hdr-morado">
    <h1>âš™ï¸ MÃ¡s</h1>
    <p>Opciones y herramientas</p>
  </div>
  <div class="sb">

    <!-- EXPORTAR / IMPORTAR -->
    <div class="card">
      <div class="ct"><span>ğŸ’¾</span> Copia de Seguridad</div>
      <p class="text-g" style="margin-bottom:10px;line-height:1.5">GuardÃ¡ todos tus datos en un archivo y restauralos cuando quieras. <strong style="color:var(--oscuro)">Recomendado antes de desinstalar la app.</strong></p>
      <button class="btn btn-g mb12" onclick="exportarDatos()">
        ğŸ“¤ Exportar mis datos (.json)
      </button>
      <div style="border:2px dashed #e5e7eb;border-radius:14px;padding:14px;text-align:center;cursor:pointer;transition:all .2s" id="importZone" onclick="abrirImportarArchivo()" ondragover="event.preventDefault();this.style.borderColor='var(--verde)'" ondragleave="this.style.borderColor='#e5e7eb'">
        <div style="font-size:28px">ğŸ“¥</div>
        <div style="font-size:14px;font-weight:700;color:var(--gris);margin-top:6px">TocÃ¡ para importar un archivo de respaldo</div>
        <div style="font-size:11px;color:var(--gris2);margin-top:3px">SeleccionÃ¡ el archivo .json exportado por esta app</div>
      </div>
      <input type="file" id="importInput" accept=".json,application/json,text/plain,*/*" style="display:none" onchange="importarDatos(event)">
      <div id="importStatus" style="margin-top:10px;display:none"></div>
    </div>

    <!-- COMPARTIR RESUMEN -->
    <div class="card">
      <div class="ct"><span>ğŸ“¤</span> Compartir con mi MÃ©dico</div>
      <p class="text-g mb12">GenerÃ¡ un resumen de tu salud para enviar por WhatsApp o correo.</p>
      <button class="btn btn-m" onclick="compartirResumen()">ğŸ“² Generar y Compartir Resumen</button>
    </div>

    <!-- FARMACIA / HOSPITAL -->
    <div class="card">
      <div class="ct"><span>ğŸ—ºï¸</span> Buscar Cerca</div>
      <div class="g2">
        <button class="btn btn-teal btn-sm" style="width:100%" onclick="buscarCerca('farmacia')">ğŸ’Š Farmacia</button>
        <button class="btn btn-r btn-sm" style="width:100%" onclick="buscarCerca('hospital')">ğŸ¥ Hospital</button>
      </div>
    </div>

    <!-- FOTO RECETAS -->
    <div class="card">
      <div class="ct"><span>ğŸ“¸</span> Mis Recetas y Estudios</div>
      <button class="btn btn-teal mb12" onclick="document.getElementById('fotoInput').click()">ğŸ“· Agregar Foto / Documento</button>
      <input type="file" id="fotoInput" accept="image/*" style="display:none" capture="environment" onchange="agregarFoto(event)">
      <div id="fotosList"><div class="empty"><div class="ei">ğŸ“„</div><p>Sin fotos guardadas.</p></div></div>
    </div>

    <!-- NOTAS MÃ‰DICAS -->
    <div class="card">
      <div class="ct"><span>ğŸ“</span> Notas MÃ©dicas</div>
      <button class="btn btn-g mb12" style="font-size:13px;padding:10px" onclick="openMod('modalNota')">+ Nueva Nota</button>
      <div id="notasList"><div class="empty"><div class="ei">ğŸ“</div><p>Sin notas.</p></div></div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: PERFIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-perfil">
  <div class="hdr hdr-teal">
    <h1>ğŸ‘¤ Mi Perfil</h1>
    <p>Datos personales y configuraciÃ³n</p>
  </div>
  <div class="sb">
    <div class="card">
      <div class="prof-hdr">
        <div class="prof-avatar" id="profAvatar">ğŸ‘´</div>
        <div>
          <div class="prof-name" id="profName">Mi Nombre</div>
          <div class="prof-age" id="profAge">CompletÃ¡ tu perfil</div>
        </div>
      </div>
      <div class="g2">
        <div class="fg"><label class="fl">Nombre</label><input class="fi" id="pfNombre" placeholder="Juan GarcÃ­a"></div>
        <div class="fg"><label class="fl">Nacimiento</label><input class="fi" id="pfNac" type="date"></div>
        <div class="fg"><label class="fl">GÃ©nero</label>
          <select class="fi" id="pfGenero">
            <option value="hombre">ğŸ‘´ Hombre</option>
            <option value="mujer">ğŸ‘µ Mujer</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Grupo SanguÃ­neo</label>
          <select class="fi" id="pfSangre">
            <option value="">â€”</option>
            <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
            <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">MÃ©dico de Cabecera</label><input class="fi" id="pfMedico" placeholder="Dr. / Dra."></div>
      <div class="fg"><label class="fl">TelÃ©fono del MÃ©dico</label><input class="fi" id="pfTelMed" type="tel" placeholder="0800..."></div>
      <div class="fg"><label class="fl">Contacto de Emergencia (nombre y tel.)</label><input class="fi" id="pfContacto" placeholder="Hija Ana: 11-1234-5678"></div>
      <div class="fg"><label class="fl">Obra Social / Prepaga</label><input class="fi" id="pfObraSocial" placeholder="PAMI, OSDE..."></div>
      <div class="fg"><label class="fl">NÂº Afiliado</label><input class="fi" id="pfAfiliado" placeholder="NÃºmero de afiliado"></div>
      <div class="fg"><label class="fl">Altura (cm)</label><input class="fi" id="pfAltura" type="number" placeholder="165"></div>
      <button class="btn btn-teal" onclick="guardarPerfil()">ğŸ’¾ Guardar Perfil</button>
    </div>

    <!-- SEGURIDAD PIN -->
    <div class="card">
      <div class="ct"><span>ğŸ”’</span> Seguridad</div>
      <div class="fg"><label class="fl">PIN de 4 dÃ­gitos (opcional)</label><input class="fi" id="pfPin" type="password" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric"></div>
      <button class="btn btn-m" style="font-size:13px;padding:10px" onclick="guardarPin()">ğŸ”’ Guardar PIN</button>
    </div>

    <!-- NOTIFICACIONES -->
    <div class="card">
      <div class="ct"><span>ğŸ””</span> Notificaciones</div>
      <div class="trow">
        <div class="tlbl">Alarmas medicamentos<small>Avisa a la hora del medicamento</small></div>
        <div class="tog on" id="togMeds" onclick="this.classList.toggle('on')"></div>
      </div>
      <div class="trow">
        <div class="tlbl">Recordatorio agua<small>Cada 2 horas</small></div>
        <div class="tog" id="togAgua" onclick="this.classList.toggle('on')"></div>
      </div>
      <div class="trow">
        <div class="tlbl">Recordatorio vitales<small>Cada maÃ±ana</small></div>
        <div class="tog" id="togVitales" onclick="this.classList.toggle('on')"></div>
      </div>
      <div class="trow">
        <div class="tlbl">Aviso de turno<small>El dÃ­a anterior al turno</small></div>
        <div class="tog on" id="togTurnos" onclick="this.classList.toggle('on')"></div>
      </div>
    </div>

    <!-- SONIDO ALARMA -->
    <div class="card">
      <div class="ct"><span>ğŸ”Š</span> Sonido de Alarma</div>
      <div class="fg">
        <label class="fl">Tipo de sonido para recordatorio de medicamentos</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
          <div id="sndOpt-suave" onclick="selectSound('suave')" style="border:2.5px solid var(--verde);background:var(--verde-bg);border-radius:14px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s">
            <div style="font-size:26px">ğŸµ</div>
            <div style="font-size:13px;font-weight:800;color:var(--verde);margin-top:4px">Suave</div>
            <div style="font-size:11px;color:var(--gris)">Melodia tranquila</div>
          </div>
          <div id="sndOpt-intenso" onclick="selectSound('intenso')" style="border:2.5px solid #e5e7eb;background:var(--gris-bg);border-radius:14px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s">
            <div style="font-size:26px">ğŸ””</div>
            <div style="font-size:13px;font-weight:800;color:var(--gris);margin-top:4px">Intenso</div>
            <div style="font-size:11px;color:var(--gris)">Alerta urgente</div>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <button class="btn btn-g" style="font-size:13px;padding:10px" onclick="testSound('suave')">&#9654; Probar suave</button>
        <button class="btn btn-o" style="font-size:13px;padding:10px" onclick="testSound('intenso')">&#9654; Probar intenso</button>
      </div>
    </div>

    <div class="card" style="background:linear-gradient(135deg,#0f766e11,#14b8a611)">
      <div class="ct"><span>ğŸ’™</span> Mi Salud â€” v9.0</div>
      <p style="font-size:13px;color:var(--gris);line-height:1.6">AplicaciÃ³n diseÃ±ada especialmente para adultos mayores. Todos los datos se guardan en tu telÃ©fono de forma segura y privada, sin conexiÃ³n a internet.</p>
    </div>
  </div>
</div>

<!-- UPDATE BANNER -->
<div class="update-banner" id="updateBanner" onclick="abrirModalUpdate()" style="cursor:pointer">
  <div class="update-inner">
    <span style="font-size:24px">ğŸ”„</span>
    <div class="update-text">
      <strong id="updateBannerTitle">Nueva versiÃ³n disponible</strong>
      <span id="updateBannerSub">TocÃ¡ aquÃ­ para actualizar â†’</span>
    </div>
    <span style="background:rgba(255,255,255,.25);border-radius:10px;padding:7px 14px;font-size:12px;font-weight:900;color:#fff;white-space:nowrap">Ver â€º</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: CALENDARIO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-calendario">
  <div class="hdr hdr-morado">
    <h1>ğŸ“… Calendario</h1>
    <p>Todos tus eventos y recordatorios</p>
  </div>
  <div class="sb">
    <div class="card">
      <div class="cal-nav">
        <button class="cal-nav-btn" onclick="calNavMes(-1)">â€¹</button>
        <span class="cal-month" id="calMonthLabel">â€”</span>
        <button class="cal-nav-btn" onclick="calNavMes(1)">â€º</button>
      </div>
      <div class="cal-grid-header" id="calDow"></div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="cal-legend">
        <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--naranja)"></div>Medicamento</div>
        <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--azul)"></div>Turno mÃ©dico</div>
        <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--morado)"></div>Consulta</div>
        <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--verde)"></div>Vacuna</div>
      </div>
    </div>

    <!-- Eventos del dÃ­a seleccionado -->
    <div class="card" id="calDiaCard" style="display:none">
      <div class="cal-events-title" id="calDiaLabel">ğŸ“‹ Eventos del dÃ­a</div>
      <div id="calDiaEventos"></div>
    </div>

    <!-- PrÃ³ximos 30 dÃ­as -->
    <div class="card">
      <div class="ct"><span>ğŸ”œ</span> PrÃ³ximos 30 dÃ­as</div>
      <div id="calProximos">
        <div class="empty"><div class="ei">ğŸ“…</div><p>Sin eventos prÃ³ximos</p></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: NOTIFICACIONES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-notifs">
  <div class="hdr hdr-azul">
    <h1>ğŸ”” Notificaciones</h1>
    <p id="notifsSubtitle">Centro de avisos</p>
  </div>
  <div class="sb">
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
      <button onclick="marcarTodasLeidas()" style="background:none;border:1.5px solid var(--gris2);color:var(--gris);border-radius:10px;padding:6px 12px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;cursor:pointer">âœ“ Marcar todas como leÃ­das</button>
    </div>
    <div class="card" id="notifsContainer">
      <div class="empty"><div class="ei">ğŸ””</div><p>Sin notificaciones todavÃ­a.</p></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="nav">
  <button class="nb active" onclick="goPage('inicio')" id="nav-inicio"><span class="ni">ğŸ </span><span class="nl">Inicio</span></button>
  <button class="nb" onclick="goPage('recordatorios')" id="nav-recordatorios"><span class="ni">ğŸ’Š</span><span class="nl">Medicam.</span></button>
  <button class="nb" onclick="goPage('vitales')" id="nav-vitales"><span class="ni">â¤ï¸</span><span class="nl">Vitales</span></button>
  <button class="nb" onclick="goPage('historia')" id="nav-historia"><span class="ni">ğŸ¥</span><span class="nl">Historia</span></button>
  <button class="nb" onclick="goPage('mas')" id="nav-mas"><span class="ni">âš™ï¸</span><span class="nl">MÃ¡s</span></button>
  <button class="nb" onclick="goPage('perfil')" id="nav-perfil"><span class="ni">ğŸ‘¤</span><span class="nl">Perfil</span></button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- MEDICAMENTO -->
<div class="mo" id="modalMed" onclick="closeOut(event,'modalMed')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ’Š Nuevo Medicamento</div>
    <div class="fg"><label class="fl">Nombre *</label><input class="fi" id="mNombre" placeholder="Ej: Atenolol, Metformina..."></div>
    <div class="g2">
      <div class="fg"><label class="fl">Dosis</label><input class="fi" id="mDosis" placeholder="1 comprimido"></div>
      <div class="fg"><label class="fl">Horario *</label><input class="fi" id="mHora" type="time"></div>
    </div>
    <div class="fg"><label class="fl">Frecuencia</label>
      <select class="fi" id="mFreq">
        <option value="diario">Todos los dÃ­as</option>
        <option value="manana">Solo maÃ±ana</option>
        <option value="noche">Solo noche</option>
        <option value="c8h">Cada 8 horas</option>
        <option value="c12h">Cada 12 horas</option>
        <option value="semanal">Semanal</option>
      </select>
    </div>
    <div class="fg"><label class="fl">Color</label>
      <select class="fi" id="mColor">
        <option value="#e8743b">ğŸŸ  Naranja</option>
        <option value="#2563eb">ğŸ”µ Azul</option>
        <option value="#1a6b5a">ğŸŸ¢ Verde</option>
        <option value="#dc2626">ğŸ”´ Rojo</option>
        <option value="#7c3aed">ğŸŸ£ Morado</option>
        <option value="#d97706">ğŸŸ¡ Amarillo</option>
      </select>
    </div>
    <div class="fg"><label class="fl">Notas (para quÃ© sirve)</label><input class="fi" id="mNota" placeholder="Opcional..."></div>
    <button class="btn btn-o" onclick="guardarMed()">âœ… Guardar Medicamento</button>
  </div>
</div>

<!-- TURNO -->
<div class="mo" id="modalTurno" onclick="closeOut(event,'modalTurno')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ“… Nuevo Turno</div>
    <div class="fg"><label class="fl">Especialidad / MÃ©dico *</label><input class="fi" id="tEsp" placeholder="Dr. GarcÃ­a - CardiologÃ­a"></div>
    <div class="g2">
      <div class="fg"><label class="fl">Fecha *</label><input class="fi" id="tFecha" type="date"></div>
      <div class="fg"><label class="fl">Hora</label><input class="fi" id="tHora" type="time"></div>
    </div>
    <div class="fg"><label class="fl">Lugar / ClÃ­nica</label><input class="fi" id="tLugar" placeholder="Hospital Central..."></div>
    <div class="fg"><label class="fl">Notas</label><input class="fi" id="tNota" placeholder="Llevar estudios, en ayunas..."></div>
    <button class="btn btn-o" onclick="guardarTurno()">âœ… Guardar Turno</button>
  </div>
</div>

<!-- ACTIVIDAD -->
<div class="mo" id="modalActividad" onclick="closeOut(event,'modalActividad')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸƒ Registrar Actividad</div>
    <div class="fg"><label class="fl">Tipo de actividad</label>
      <select class="fi" id="actTipo">
        <option value="caminata">ğŸš¶ Caminata</option>
        <option value="ejercicio">ğŸ’ª Ejercicios en casa</option>
        <option value="bicicleta">ğŸš² Bicicleta</option>
        <option value="natacion">ğŸŠ NataciÃ³n</option>
        <option value="yoga">ğŸ§˜ Yoga / ElongaciÃ³n</option>
        <option value="otro">ğŸƒ Otro</option>
      </select>
    </div>
    <div class="g2">
      <div class="fg"><label class="fl">DuraciÃ³n (minutos)</label><input class="fi" id="actMins" type="number" placeholder="30"></div>
      <div class="fg"><label class="fl">Pasos (aprox.)</label><input class="fi" id="actPasos" type="number" placeholder="3000"></div>
    </div>
    <div class="fg"><label class="fl">Intensidad</label>
      <select class="fi" id="actIntensidad">
        <option value="baja">ğŸŸ¢ Baja (tranquila)</option>
        <option value="media">ğŸŸ¡ Media (moderada)</option>
        <option value="alta">ğŸ”´ Alta (intensa)</option>
      </select>
    </div>
    <div class="fg"><label class="fl">CÃ³mo me sentÃ­</label><input class="fi" id="actSentido" placeholder="Bien, cansado, con dolor..."></div>
    <button class="btn btn-g" onclick="guardarActividad()">âœ… Guardar Actividad</button>
  </div>
</div>

<!-- SUEÃ‘O -->
<div class="mo" id="modalSueno" onclick="closeOut(event,'modalSueno')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ˜´ Registrar SueÃ±o</div>
    <div class="g2">
      <div class="fg"><label class="fl">Me dormÃ­ a las</label><input class="fi" id="sHDormi" type="time" value="22:00"></div>
      <div class="fg"><label class="fl">Me despertÃ© a las</label><input class="fi" id="sHDesperte" type="time" value="07:00"></div>
    </div>
    <div class="fg"><label class="fl">Calidad del sueÃ±o</label>
      <select class="fi" id="sCalidad">
        <option value="5">â­â­â­â­â­ Muy buena</option>
        <option value="4">â­â­â­â­ Buena</option>
        <option value="3">â­â­â­ Regular</option>
        <option value="2">â­â­ Mala</option>
        <option value="1">â­ Muy mala</option>
      </select>
    </div>
    <div class="fg"><label class="fl">Notas</label><input class="fi" id="sNota" placeholder="Me despertÃ© varias veces..."></div>
    <button class="btn btn-m" onclick="guardarSueno()">âœ… Guardar</button>
  </div>
</div>

<!-- CONSULTA -->
<div class="mo" id="modalConsulta" onclick="closeOut(event,'modalConsulta')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ¥ Nueva Consulta MÃ©dica</div>
    <div class="g2">
      <div class="fg"><label class="fl">Fecha *</label><input class="fi" id="cFecha" type="date"></div>
      <div class="fg"><label class="fl">Especialidad</label><input class="fi" id="cEsp" placeholder="CardiologÃ­a..."></div>
    </div>
    <div class="fg"><label class="fl">MÃ©dico</label><input class="fi" id="cMedico" placeholder="Dr. / Dra."></div>
    <div class="fg"><label class="fl">Motivo</label><input class="fi" id="cMotivo" placeholder="Control, dolor..."></div>
    <div class="fg"><label class="fl">DiagnÃ³stico</label><input class="fi" id="cDx" placeholder="HipertensiÃ³n controlada..."></div>
    <div class="fg"><label class="fl">Indicaciones</label><textarea class="fi" id="cIndic" placeholder="Tratamiento, indicaciones..."></textarea></div>
    <div class="fg"><label class="fl">PrÃ³ximo turno</label><input class="fi" id="cProx" type="date"></div>
    <button class="btn btn-a" onclick="guardarConsulta()">âœ… Guardar Consulta</button>
  </div>
</div>

<!-- ENFERMEDAD -->
<div class="mo" id="modalEnfermedad" onclick="closeOut(event,'modalEnfermedad')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ©º CondiciÃ³n de Salud</div>
    <div class="fg"><label class="fl">CondiciÃ³n *</label><input class="fi" id="enNombre" placeholder="Diabetes tipo 2, HipertensiÃ³n..."></div>
    <div class="g2">
      <div class="fg"><label class="fl">Desde (aÃ±o)</label><input class="fi" id="enDesde" type="number" placeholder="2020" min="1900" max="2100"></div>
      <div class="fg"><label class="fl">Estado</label>
        <select class="fi" id="enEstado">
          <option value="controlada">Controlada</option>
          <option value="activa">Activa</option>
          <option value="cronica">CrÃ³nica</option>
          <option value="curada">Curada</option>
        </select>
      </div>
    </div>
    <div class="fg"><label class="fl">Notas</label><input class="fi" id="enNota" placeholder="Observaciones..."></div>
    <button class="btn btn-a" onclick="guardarEnfermedad()">âœ… Guardar</button>
  </div>
</div>

<!-- ALERGIA -->
<div class="mo" id="modalAlergia" onclick="closeOut(event,'modalAlergia')">
  <div class="modal">
    <div class="mh"></div><div class="mt">âš ï¸ Alergia</div>
    <div class="fg"><label class="fl">Alergia a *</label><input class="fi" id="alNombre" placeholder="Penicilina, Ibuprofeno..."></div>
    <div class="fg"><label class="fl">Tipo</label>
      <select class="fi" id="alTipo">
        <option value="medicamento">ğŸ’Š Medicamento</option>
        <option value="alimento">ğŸ Alimento</option>
        <option value="ambiental">ğŸŒ¿ Ambiental</option>
        <option value="otro">â“ Otro</option>
      </select>
    </div>
    <div class="fg"><label class="fl">ReacciÃ³n</label><input class="fi" id="alRea" placeholder="Urticaria, dificultad respirar..."></div>
    <div class="fg"><label class="fl">Gravedad</label>
      <select class="fi" id="alGrav">
        <option value="leve">ğŸŸ¡ Leve</option>
        <option value="moderada">ğŸŸ  Moderada</option>
        <option value="grave">ğŸ”´ Grave / Anafilaxia</option>
      </select>
    </div>
    <button class="btn btn-a" onclick="guardarAlergia()">âœ… Guardar</button>
  </div>
</div>

<!-- VACUNA -->
<div class="mo" id="modalVacuna" onclick="closeOut(event,'modalVacuna')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ’‰ Vacuna</div>
    <div class="fg"><label class="fl">Vacuna *</label>
      <select class="fi" id="vacNombre">
        <option value="">SeleccionÃ¡...</option>
        <option>Antigripal (gripe)</option>
        <option>COVID-19</option>
        <option>Neumococo</option>
        <option>TÃ©tanos</option>
        <option>Hepatitis B</option>
        <option>Herpes ZÃ³ster</option>
        <option>Doble Bacteriana</option>
        <option>Otra</option>
      </select>
    </div>
    <div class="g2">
      <div class="fg"><label class="fl">Fecha</label><input class="fi" id="vacFecha" type="date"></div>
      <div class="fg"><label class="fl">PrÃ³xima dosis</label><input class="fi" id="vacProx" type="date"></div>
    </div>
    <div class="fg"><label class="fl">Notas</label><input class="fi" id="vacNota" placeholder="Lote, lugar de aplicaciÃ³n..."></div>
    <button class="btn btn-a" onclick="guardarVacuna()">âœ… Guardar</button>
  </div>
</div>

<!-- DIETA -->
<div class="mo" id="modalDieta" onclick="closeOut(event,'modalDieta')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ½ï¸ RestricciÃ³n Alimentaria</div>
    <div class="fg"><label class="fl">Alimento / Grupo *</label><input class="fi" id="dAlimento" placeholder="Sal, azÃºcar, lÃ¡cteos, grasas..."></div>
    <div class="fg"><label class="fl">Tipo de restricciÃ³n</label>
      <select class="fi" id="dTipo">
        <option value="prohibido">ğŸ”´ Prohibido</option>
        <option value="reducir">ğŸŸ  Reducir</option>
        <option value="recomendado">ğŸŸ¢ Recomendado</option>
      </select>
    </div>
    <div class="fg"><label class="fl">Motivo / IndicaciÃ³n mÃ©dica</label><input class="fi" id="dMotivo" placeholder="Por hipertensiÃ³n, diabetes..."></div>
    <button class="btn btn-a" onclick="guardarDieta()">âœ… Guardar</button>
  </div>
</div>

<!-- NOTA -->
<div class="mo" id="modalNota" onclick="closeOut(event,'modalNota')">
  <div class="modal">
    <div class="mh"></div><div class="mt">ğŸ“ Nueva Nota</div>
    <div class="fg"><label class="fl">TÃ­tulo</label><input class="fi" id="nTitulo" placeholder="Ej: Instrucciones del mÃ©dico"></div>
    <div class="fg"><label class="fl">Nota</label><textarea class="fi" id="nContenido" rows="5" placeholder="EscribÃ­ aquÃ­..."></textarea></div>
    <button class="btn btn-g" onclick="guardarNota()">âœ… Guardar Nota</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ESTADO GLOBAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_VERSION = '9.0';
const GITHUB_REPO = 'jotadev23-23/mi-salud-app';
const VERSION_JSON_URL = 'https://raw.githubusercontent.com/'+GITHUB_REPO+'/main/version.json';

let D = {
  perfil:{},
  medicamentos:[],
  vitales:[],
  consultas:[],
  enfermedades:[],
  alergias:[],
  vacunas:[],
  dieta:[],
  actividades:[],
  sueno:[],
  turnos:[],
  notas:[],
  fotos:[],
  water:{},
  pin:'',
  notifs:[],
  config:{}
};

function load(){try{const s=localStorage.getItem('msv2');if(s)D=Object.assign(D,JSON.parse(s));}catch(e){}}
function save(){try{localStorage.setItem('msv2',JSON.stringify(D));}catch(e){}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pinInput='', pinMode='verify';
function initPin(){
  if(!D.pin){pinSkip();return;}
  document.getElementById('pinOverlay').classList.add('show');
  pinMode='verify';
  document.getElementById('pinSub').textContent='IngresÃ¡ tu PIN';
}
function pinKey(k){
  if(pinInput.length>=4)return;
  pinInput+=k;
  updatePinDots();
  if(pinInput.length===4){
    setTimeout(()=>{
      if(pinMode==='verify'){
        if(pinInput===D.pin){document.getElementById('pinOverlay').classList.remove('show');pinInput='';}
        else{document.getElementById('pinErr').textContent='PIN incorrecto, intentÃ¡ de nuevo';pinInput='';updatePinDots();}
      } else {
        D.pin=pinInput;save();
        document.getElementById('pinOverlay').classList.remove('show');
        pinInput='';toast('ğŸ”’ PIN guardado');
      }
    },200);
  }
}
function pinDel(){pinInput=pinInput.slice(0,-1);updatePinDots();document.getElementById('pinErr').textContent='';}
function pinSkip(){document.getElementById('pinOverlay').classList.remove('show');pinInput='';}
function updatePinDots(){
  for(let i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('filled',i<pinInput.length);
}
function guardarPin(){
  const p=document.getElementById('pfPin').value;
  if(p.length===4&&/^\d{4}$/.test(p)){D.pin=p;save();toast('ğŸ”’ PIN guardado');}
  else if(p.length===0){D.pin='';save();toast('ğŸ”“ PIN eliminado');}
  else toast('âš ï¸ El PIN debe ser de 4 dÃ­gitos');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAVEGACIÃ“N â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(p){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(x=>x.classList.remove('active'));
  const pg=document.getElementById('page-'+p);
  if(pg)pg.classList.add('active');
  const nb=document.getElementById('nav-'+p);
  if(nb)nb.classList.add('active');
  if(p==='inicio')renderHome();
  if(p==='calendario')renderCalendario();
  if(p==='notifs'){renderNotifs();setTimeout(marcarTodasLeidas,800);}
  window.scrollTo(0,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMod(id){document.getElementById(id).classList.add('open');}
function closeMod(id){document.getElementById(id).classList.remove('open');}
function closeOut(e,id){if(e.target===document.getElementById(id))closeMod(id);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FECHA / HORA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDate(){
  const n=new Date();
  const h=n.getHours();
  const g=h<12?'Â¡Buen dÃ­a! â˜€ï¸':h<19?'Â¡Buenas tardes! ğŸŒ¤ï¸':'Â¡Buenas noches! ğŸŒ™';
  document.getElementById('greetTitle').textContent=g;
  document.getElementById('hdrDate').textContent=n.toLocaleDateString('es-AR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('cFecha').value=n.toISOString().split('T')[0];
  document.getElementById('tFecha').value=n.toISOString().split('T')[0];
  document.getElementById('vacFecha').value=n.toISOString().split('T')[0];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PERFIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function guardarPerfil(){
  D.perfil={
    nombre:document.getElementById('pfNombre').value,
    nac:document.getElementById('pfNac').value,
    genero:document.getElementById('pfGenero').value,
    sangre:document.getElementById('pfSangre').value,
    medico:document.getElementById('pfMedico').value,
    telMed:document.getElementById('pfTelMed').value,
    contacto:document.getElementById('pfContacto').value,
    obraSocial:document.getElementById('pfObraSocial').value,
    afiliado:document.getElementById('pfAfiliado').value,
    altura:document.getElementById('pfAltura').value
  };
  save();renderPerfil();renderHome();toast('âœ… Perfil guardado');
}
function renderPerfil(){
  const p=D.perfil;
  if(!p.nombre)return;
  document.getElementById('pfNombre').value=p.nombre||'';
  document.getElementById('pfNac').value=p.nac||'';
  document.getElementById('pfGenero').value=p.genero||'hombre';
  document.getElementById('pfSangre').value=p.sangre||'';
  document.getElementById('pfMedico').value=p.medico||'';
  document.getElementById('pfTelMed').value=p.telMed||'';
  document.getElementById('pfContacto').value=p.contacto||'';
  document.getElementById('pfObraSocial').value=p.obraSocial||'';
  document.getElementById('pfAfiliado').value=p.afiliado||'';
  document.getElementById('pfAltura').value=p.altura||'';
  document.getElementById('profName').textContent=p.nombre;
  document.getElementById('profAvatar').textContent=p.genero==='mujer'?'ğŸ‘µ':'ğŸ‘´';
  if(p.nac){
    const edad=Math.floor((new Date()-new Date(p.nac))/(365.25*24*3600*1000));
    document.getElementById('profAge').textContent=edad+' aÃ±os â€¢ '+(p.sangre||'?')+'  â€¢ '+(p.obraSocial||'');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(){
  const p=D.perfil;
  document.getElementById('hdrName').textContent=p.nombre||'Mi Salud';
  const avatar=p.genero==='mujer'?'ğŸ‘µ':'ğŸ‘´';
  
  // Carnet
  const setTxt=(id,val)=>{const e=document.getElementById(id);if(e)e.textContent=val;};
  setTxt('carnetName',p.nombre||'Sin nombre');
  setTxt('carnetInfo',(p.nac?calcEdad(p.nac)+' aÃ±os â€¢ ':'')+(p.obraSocial||'')+(p.afiliado?' NÂº'+p.afiliado:''));
  setTxt('carnetSangre',p.sangre||'â€”');
  setTxt('carnetMeds',D.medicamentos.length?D.medicamentos.length+' activos':'Ninguno');
  setTxt('carnetAlerg',D.alergias.length?D.alergias.map(a=>a.nombre).join(', '):'Ninguna');
  setTxt('carnetAvatar',avatar);

  // Vitales
  const v=D.vitales[0];
  document.getElementById('hPA').textContent=v?.pa||'â€”';
  document.getElementById('hFC').textContent=v?.fc?v.fc+'lpm':'â€”';
  document.getElementById('hTemp').textContent=v?.temp?v.temp+'Â°':'â€”';
  document.getElementById('hSO2').textContent=v?.so2?v.so2+'%':'â€”';

  // Agua
  renderWater();

  // Medicamentos
  renderHomeReminders();

  // Actividad hoy
  const hoy=new Date().toISOString().split('T')[0];
  const actsHoy=D.actividades.filter(a=>a.fecha===hoy);
  const totalPasos=actsHoy.reduce((s,a)=>s+(parseInt(a.pasos)||0),0);
  const totalMins=actsHoy.reduce((s,a)=>s+(parseInt(a.mins)||0),0);
  const totalCals=Math.round(totalMins*4.5);
  document.getElementById('hPasos').textContent=totalPasos>999?(totalPasos/1000).toFixed(1)+'k':totalPasos;
  document.getElementById('hMins').textContent=totalMins;
  document.getElementById('hCals').textContent=totalCals;

  // SueÃ±o
  const suHoy=D.sueno.find(s=>s.fecha===hoy);
  if(suHoy){
    const h=suHoy.horas;
    const pct=Math.min(100,Math.round(h/9*100));
    document.getElementById('sleepFill').style.width=pct+'%';
    document.getElementById('sleepLbl').textContent=h.toFixed(1)+' hs de sueÃ±o â€¢ '+
      ['','â­','â­â­','â­â­â­','â­â­â­â­','â­â­â­â­â­'][suHoy.calidad||3];
  }

  // Turnos
  renderHomeTurnos();
}

function calcEdad(nac){return Math.floor((new Date()-new Date(nac))/(365.25*24*3600*1000));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AGUA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWater(){
  const hoy=new Date().toISOString().split('T')[0];
  if(!D.water[hoy])D.water[hoy]=0;
  const n=D.water[hoy];
  let html='';
  for(let i=0;i<8;i++) html+=`<span class="water-glass ${i<n?'filled':''}" onclick="toggleWater(${i})">ğŸ’§</span>`;
  document.getElementById('waterTrack').innerHTML=html;
  document.getElementById('waterCount').textContent=n+' / 8 vasos tomados ('+Math.round(n*250/1000*10)/10+' litros)';
}
function toggleWater(i){
  const hoy=new Date().toISOString().split('T')[0];
  D.water[hoy]=i+1;
  save();renderWater();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MEDICAMENTOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingMedId=null;
function guardarMed(){
  const nombre=document.getElementById('mNombre').value.trim();
  if(!nombre){toast('âš ï¸ IngresÃ¡ el nombre');return;}
  const hora=document.getElementById('mHora').value;
  if(!hora){toast('âš ï¸ IngresÃ¡ el horario');return;}
  if(editingMedId){
    const m=D.medicamentos.find(x=>x.id===editingMedId);
    if(m){m.nombre=nombre;m.dosis=document.getElementById('mDosis').value;m.hora=hora;
      m.freq=document.getElementById('mFreq').value;m.color=document.getElementById('mColor').value;
      m.nota=document.getElementById('mNota').value;}
    editingMedId=null;
    document.querySelector('#modalMed .mt').textContent='ğŸ’Š Nuevo Medicamento';
  } else {
    D.medicamentos.push({id:Date.now(),nombre,dosis:document.getElementById('mDosis').value,
      hora,freq:document.getElementById('mFreq').value,color:document.getElementById('mColor').value,
      nota:document.getElementById('mNota').value,tomados:{}});
  }
  save();closeMod('modalMed');
  clearF(['mNombre','mDosis','mNota']);
  renderMeds();renderHome();toast('ğŸ’Š Medicamento guardado');
  syncAlarmasNativas();
}
function editMed(id){
  const m=D.medicamentos.find(x=>x.id===id);if(!m)return;
  editingMedId=id;
  document.getElementById('mNombre').value=m.nombre||'';
  document.getElementById('mDosis').value=m.dosis||'';
  document.getElementById('mHora').value=m.hora||'';
  document.getElementById('mFreq').value=m.freq||'diario';
  document.getElementById('mColor').value=m.color||'#e8743b';
  document.getElementById('mNota').value=m.nota||'';
  document.querySelector('#modalMed .mt').textContent='âœï¸ Editar Medicamento';
  openMod('modalMed');
}
function renderMeds(){
  const el=document.getElementById('medList');
  if(!D.medicamentos.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ’Š</div><p>Sin medicamentos.</p></div>';return;}
  const hoy=new Date().toISOString().split('T')[0];
  el.innerHTML=D.medicamentos.map(m=>{
    const t=m.tomados[hoy];
    return `<div class="li">
      <div class="pill-icon" style="background:${m.color}22"><span style="font-size:19px">ğŸ’Š</span></div>
      <div class="lic">
        <div class="lin">${m.nombre}</div>
        <div class="lid">â° ${fmtH(m.hora)} â€¢ ${freqL(m.freq)}</div>
        ${m.dosis?`<div class="lism">${m.dosis}</div>`:''}
      </div>
      <button class="cbtn ${t?'done':''}" onclick="toggleMed(${m.id})">${t?'âœ“':'â—‹'}</button>
      <button class="del-btn" style="color:var(--azul)" onclick="editMed(${m.id})">âœï¸</button>
      <button class="del-btn" onclick="delItem('medicamentos',${m.id},renderMeds)">ğŸ—‘ï¸</button>
    </div>`;
  }).join('');
}
function renderHomeReminders(){
  const el=document.getElementById('homeReminders');
  if(!D.medicamentos.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ’Š</div><p>Sin medicamentos. AgregÃ¡ en Recordatorios.</p></div>';return;}
  const hoy=new Date().toISOString().split('T')[0];
  el.innerHTML=D.medicamentos.map(m=>{
    const t=m.tomados[hoy];
    return `<div class="li">
      <div class="pill-icon" style="background:${m.color}22"><span>ğŸ’Š</span></div>
      <div class="lic"><div class="lin">${m.nombre}</div><div class="lid">â° ${fmtH(m.hora)}</div></div>
      <button class="cbtn ${t?'done':''}" onclick="toggleMed(${m.id})">${t?'âœ“':'â—‹'}</button>
    </div>`;
  }).join('');
}
function toggleMed(id){
  const m=D.medicamentos.find(x=>x.id===id);if(!m)return;
  const hoy=new Date().toISOString().split('T')[0];
  m.tomados[hoy]=!m.tomados[hoy];
  save();renderMeds();renderHome();
}
function freqL(f){return{diario:'Todos los dÃ­as',manana:'MaÃ±ana',noche:'Noche',c8h:'Cada 8h',c12h:'Cada 12h',semanal:'Semanal'}[f]||f;}
function fmtH(h){if(!h)return'';const[hr,m]=h.split(':');const h12=parseInt(hr)%12||12;return`${h12}:${m} ${parseInt(hr)>=12?'PM':'AM'}`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TURNOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingTurnoId=null;
function guardarTurno(){
  const esp=document.getElementById('tEsp').value.trim();
  if(!esp){toast('âš ï¸ IngresÃ¡ la especialidad');return;}
  const fecha=document.getElementById('tFecha').value;
  if(!fecha){toast('âš ï¸ IngresÃ¡ la fecha');return;}
  if(editingTurnoId){
    const t=D.turnos.find(x=>x.id===editingTurnoId);
    if(t){t.esp=esp;t.fecha=fecha;t.hora=document.getElementById('tHora').value;
      t.lugar=document.getElementById('tLugar').value;t.nota=document.getElementById('tNota').value;}
    editingTurnoId=null;
    document.querySelector('#modalTurno .mt').textContent='ğŸ“… Nuevo Turno';
  } else {
    D.turnos.push({id:Date.now(),esp,fecha,hora:document.getElementById('tHora').value,
      lugar:document.getElementById('tLugar').value,nota:document.getElementById('tNota').value});
  }
  D.turnos.sort((a,b)=>a.fecha>b.fecha?1:-1);
  save();closeMod('modalTurno');
  clearF(['tEsp','tLugar','tNota']);
  renderTurnos();renderHome();toast('ğŸ“… Turno guardado');setTimeout(()=>{generarNotificacionesProgramadas();syncAlarmasNativas();},300);
}
function editTurno(id){
  const t=D.turnos.find(x=>x.id===id);if(!t)return;
  editingTurnoId=id;
  document.getElementById('tEsp').value=t.esp||'';
  document.getElementById('tFecha').value=t.fecha||'';
  document.getElementById('tHora').value=t.hora||'';
  document.getElementById('tLugar').value=t.lugar||'';
  document.getElementById('tNota').value=t.nota||'';
  document.querySelector('#modalTurno .mt').textContent='âœï¸ Editar Turno';
  openMod('modalTurno');
}
function _buildTurnoHTML(t, deleteFn){
  const f=new Date(t.fecha+'T00:00:00');
  const pasado=f<new Date();
  return `<div class="li" style="${pasado?'opacity:.5':''}">
    <div class="icon-box" style="background:${pasado?'#e5e7eb':'var(--azul-bg)'}">
      <span style="font-size:19px">ğŸ“…</span>
    </div>
    <div class="lic">
      <div class="lin">${t.esp}</div>
      <div class="lid">${f.toLocaleDateString('es-AR')}${t.hora?' a las '+fmtH(t.hora):''}</div>
      ${t.lugar?`<div class="lism">ğŸ“ ${t.lugar}</div>`:''}
      ${t.nota?`<div class="lism">ğŸ“ ${t.nota}</div>`:''}
    </div>
    <button class="del-btn" style="color:var(--azul)" onclick="editTurno(${t.id})">âœï¸</button>
    <button class="del-btn" onclick="${deleteFn}('turnos',${t.id})">ğŸ—‘ï¸</button>
  </div>`;
}
function renderTurnos(){
  // (legacy â€” mantenido para compatibilidad)
  renderTurnosHist();
}
function renderTurnosHist(){
  const el=document.getElementById('turnosListHist');
  if(!el) return;
  if(!D.turnos.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“…</div><p>Sin turnos agendados.</p></div>';return;}
  el.innerHTML=D.turnos.map(t=>{
    const f=new Date(t.fecha+'T00:00:00');
    const pasado=f<new Date();
    return `<div class="li" style="${pasado?'opacity:.5':''}">
      <div class="icon-box" style="background:${pasado?'#e5e7eb':'var(--azul-bg)'}">
        <span style="font-size:19px">ğŸ“…</span>
      </div>
      <div class="lic">
        <div class="lin">${t.esp}</div>
        <div class="lid">${f.toLocaleDateString('es-AR')}${t.hora?' a las '+fmtH(t.hora):''}</div>
        ${t.lugar?`<div class="lism">ğŸ“ ${t.lugar}</div>`:''}
        ${t.nota?`<div class="lism">ğŸ“ ${t.nota}</div>`:''}
      </div>
      <button class="del-btn" style="color:var(--azul)" onclick="editTurno(${t.id})">âœï¸</button>
      <button class="del-btn" onclick="delItemAndRefreshTurnos(${t.id})">ğŸ—‘ï¸</button>
    </div>`;
  }).join('');
}
function delItemAndRefreshTurnos(id){
  if(!confirm('Â¿Eliminar este turno?'))return;
  D.turnos=D.turnos.filter(x=>x.id!==id);
  save();renderTurnosHist();renderHomeTurnos();syncAlarmasNativas();
}
function renderHomeTurnos(){
  const el=document.getElementById('homeTurnos');
  const hoy=new Date();hoy.setHours(0,0,0,0);
  const prox=D.turnos.filter(t=>new Date(t.fecha+'T00:00:00')>=hoy).slice(0,3);
  if(!prox.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“…</div><p>Sin turnos prÃ³ximos.</p></div>';return;}
  el.innerHTML=prox.map(t=>{
    const f=new Date(t.fecha+'T00:00:00');
    const dias=Math.round((f-hoy)/(24*3600*1000));
    const label=dias===0?'HOY':dias===1?'MaÃ±ana':dias+' dÃ­as';
    return `<div class="li">
      <div class="icon-box" style="background:var(--azul-bg)"><span style="font-size:18px">ğŸ“…</span></div>
      <div class="lic"><div class="lin">${t.esp}</div><div class="lid">${f.toLocaleDateString('es-AR')}${t.hora?' '+fmtH(t.hora):''}</div></div>
      <span style="font-size:11px;font-weight:800;color:var(--azul);background:var(--azul-bg);padding:4px 8px;border-radius:20px">${label}</span>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VITALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function guardarVitales(){
  const e={id:Date.now(),fecha:new Date().toISOString(),
    pa:document.getElementById('inPA').value,
    fc:document.getElementById('inFC').value,
    temp:document.getElementById('inTemp').value,
    so2:document.getElementById('inSO2').value,
    peso:document.getElementById('inPeso').value,
    glucosa:document.getElementById('inGlucosa').value,
    nota:document.getElementById('inVNote').value};
  if(!e.pa&&!e.fc&&!e.temp&&!e.so2&&!e.peso&&!e.glucosa){toast('âš ï¸ IngresÃ¡ al menos una mediciÃ³n');return;}
  D.vitales.unshift(e);save();
  clearF(['inPA','inFC','inTemp','inSO2','inPeso','inGlucosa','inVNote']);
  renderVitales();renderHome();renderCharts();toast('âœ… MediciÃ³n guardada');
}
function renderVitales(){
  const el=document.getElementById('vitalesList');
  if(!D.vitales.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div><p>Sin mediciones.</p></div>';return;}
  el.innerHTML=D.vitales.slice(0,15).map(v=>{
    const f=new Date(v.fecha);
    const items=[];
    if(v.pa)items.push(`ğŸ©¸ ${v.pa}`);
    if(v.fc)items.push(`ğŸ’“ ${v.fc} lpm`);
    if(v.temp)items.push(`ğŸŒ¡ï¸ ${v.temp}Â°C`);
    if(v.so2)items.push(`ğŸ« ${v.so2}%`);
    if(v.peso)items.push(`âš–ï¸ ${v.peso} kg`);
    if(v.glucosa)items.push(`ğŸ©¸ ${v.glucosa} mg/dL`);
    return `<div class="li" style="flex-wrap:wrap;gap:6px">
      <div style="width:100%">
        <div style="font-size:11px;font-weight:700;color:var(--gris)">${f.toLocaleDateString('es-AR',{day:'2-digit',month:'short',year:'numeric'})} ${f.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'})}</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:5px">
          ${items.map(i=>`<span style="font-size:12px;font-weight:700;background:var(--gris-bg);padding:3px 8px;border-radius:20px">${i}</span>`).join('')}
        </div>
        ${v.nota?`<div style="font-size:11px;color:var(--gris);margin-top:4px;font-style:italic">ğŸ“ ${v.nota}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHARTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts(){
  drawChart('chartPA', D.vitales.filter(v=>v.pa).slice(0,10).reverse(), v=>parseInt(v.pa.split('/')[0]),'SistÃ³lica','#dc2626',60,200);
  drawChart('chartPeso', D.vitales.filter(v=>v.peso).slice(0,10).reverse(), v=>parseFloat(v.peso),'Peso kg','#7c3aed',40,120);
  drawChart('chartGlucosa', D.vitales.filter(v=>v.glucosa).slice(0,10).reverse(), v=>parseFloat(v.glucosa),'Glucosa','#d97706',60,200);
}
function drawChart(id,data,fn,label,color,minY,maxY){
  const canvas=document.getElementById(id);
  if(!canvas)return;
  const W=canvas.parentElement.offsetWidth-2;
  canvas.width=W;canvas.height=120;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,120);
  if(!data.length){
    ctx.fillStyle='#9ca3af';ctx.font='12px Nunito,sans-serif';ctx.textAlign='center';
    ctx.fillText('Sin datos suficientes',W/2,60);return;
  }
  const pad={l:36,r:10,t:10,b:24};
  const W2=W-pad.l-pad.r, H2=120-pad.t-pad.b;
  // Grid lines
  ctx.strokeStyle='#f3f4f6';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+H2*(1-i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle='#9ca3af';ctx.font='9px Nunito,sans-serif';ctx.textAlign='right';
    ctx.fillText(Math.round(minY+i*(maxY-minY)/4),pad.l-4,y+3);
  }
  if(data.length<2){
    const v=fn(data[0]);
    const y=pad.t+H2*(1-(v-minY)/(maxY-minY));
    ctx.fillStyle=color;ctx.beginPath();ctx.arc(pad.l+W2/2,y,5,0,Math.PI*2);ctx.fill();
    return;
  }
  // Line
  ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.lineJoin='round';
  data.forEach((d,i)=>{
    const x=pad.l+i*(W2/(data.length-1));
    const v=Math.max(minY,Math.min(maxY,fn(d)));
    const y=pad.t+H2*(1-(v-minY)/(maxY-minY));
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();
  // Gradient fill
  const grad=ctx.createLinearGradient(0,pad.t,0,pad.t+H2);
  grad.addColorStop(0,color+'44');grad.addColorStop(1,color+'00');
  ctx.beginPath();
  data.forEach((d,i)=>{
    const x=pad.l+i*(W2/(data.length-1));
    const v=Math.max(minY,Math.min(maxY,fn(d)));
    const y=pad.t+H2*(1-(v-minY)/(maxY-minY));
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.lineTo(pad.l+W2,pad.t+H2);ctx.lineTo(pad.l,pad.t+H2);ctx.closePath();
  ctx.fillStyle=grad;ctx.fill();
  // Dots
  data.forEach((d,i)=>{
    const x=pad.l+i*(W2/(data.length-1));
    const v=Math.max(minY,Math.min(maxY,fn(d)));
    const y=pad.t+H2*(1-(v-minY)/(maxY-minY));
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=color;ctx.beginPath();ctx.arc(x,y,2.5,0,Math.PI*2);ctx.fill();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HISTORIA CLÃNICA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(t,btn){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const allTabs=['turnos-hist','agenda-hist','consultas','enfermedades','alergias','vacunas','dieta'];
  allTabs.forEach(x=>{
    const el=document.getElementById('tab-'+x);
    if(el) el.style.display=x===t?'block':'none';
  });
  if(t==='turnos-hist') renderTurnosHist();
  if(t==='agenda-hist') renderCalendarioHist();
}
let editingConsultaId=null;
function guardarConsulta(){
  const esp=document.getElementById('cEsp').value.trim();
  const fecha=document.getElementById('cFecha').value;
  if(!esp||!fecha){toast('âš ï¸ CompletÃ¡ los campos obligatorios');return;}
  if(editingConsultaId){
    const c=D.consultas.find(x=>x.id===editingConsultaId);
    if(c){c.fecha=fecha;c.esp=esp;c.medico=document.getElementById('cMedico').value;
      c.motivo=document.getElementById('cMotivo').value;c.dx=document.getElementById('cDx').value;
      c.indic=document.getElementById('cIndic').value;c.prox=document.getElementById('cProx').value;}
    editingConsultaId=null;
    document.querySelector('#modalConsulta .mt').textContent='ğŸ¥ Nueva Consulta MÃ©dica';
  } else {
    D.consultas.unshift({id:Date.now(),fecha,esp,medico:document.getElementById('cMedico').value,
      motivo:document.getElementById('cMotivo').value,dx:document.getElementById('cDx').value,
      indic:document.getElementById('cIndic').value,prox:document.getElementById('cProx').value});
  }
  save();closeMod('modalConsulta');clearF(['cEsp','cMedico','cMotivo','cDx','cIndic','cProx']);
  renderConsultas();toast('âœ… Consulta guardada');setTimeout(()=>{generarNotificacionesProgramadas();syncAlarmasNativas();},300);
}
function editConsulta(id){
  const c=D.consultas.find(x=>x.id===id);if(!c)return;
  editingConsultaId=id;
  document.getElementById('cFecha').value=c.fecha||'';
  document.getElementById('cEsp').value=c.esp||'';
  document.getElementById('cMedico').value=c.medico||'';
  document.getElementById('cMotivo').value=c.motivo||'';
  document.getElementById('cDx').value=c.dx||'';
  document.getElementById('cIndic').value=c.indic||'';
  document.getElementById('cProx').value=c.prox||'';
  document.querySelector('#modalConsulta .mt').textContent='âœï¸ Editar Consulta';
  openMod('modalConsulta');
}
function renderConsultas(){
  const el=document.getElementById('consultasList');
  if(!D.consultas.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ¥</div><p>Sin consultas.</p></div>';return;}
  el.innerHTML=D.consultas.map(c=>{
    const f=new Date(c.fecha+'T00:00:00');
    return `<div class="hist-item">
      <div class="hist-date"><strong style="font-size:18px;color:var(--azul)">${f.getDate()}</strong><br>${f.toLocaleDateString('es-AR',{month:'short'})}<br>${f.getFullYear()}</div>
      <div class="hist-c">
        <div class="hist-t">${c.esp}${c.medico?' â€” '+c.medico:''}</div>
        ${c.motivo?`<div class="hist-d">${c.motivo}</div>`:''}
        ${c.dx?`<span class="hist-tag" style="background:var(--azul-bg);color:var(--azul)">${c.dx}</span>`:''}
        ${c.indic?`<div class="hist-d" style="margin-top:4px">ğŸ’Š ${c.indic}</div>`:''}
        ${c.prox?`<div class="hist-d">ğŸ“… PrÃ³ximo: ${new Date(c.prox+'T00:00:00').toLocaleDateString('es-AR')}</div>`:''}
      </div>
      <button class="del-btn" style="color:var(--azul)" onclick="editConsulta(${c.id})">âœï¸</button>
      <button class="del-btn" onclick="delItem('consultas',${c.id},renderConsultas)">ğŸ—‘ï¸</button>
    </div>`;
  }).join('');
}
function guardarEnfermedad(){
  const n=document.getElementById('enNombre').value.trim();
  if(!n){toast('âš ï¸ IngresÃ¡ la condiciÃ³n');return;}
  D.enfermedades.push({id:Date.now(),nombre:n,desde:document.getElementById('enDesde').value,
    estado:document.getElementById('enEstado').value,nota:document.getElementById('enNota').value});
  save();closeMod('modalEnfermedad');clearF(['enNombre','enDesde','enNota']);
  renderEnfermedades();toast('âœ… CondiciÃ³n guardada');
}
function renderEnfermedades(){
  const el=document.getElementById('enfermedadesList');
  if(!D.enfermedades.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ©º</div><p>Sin condiciones.</p></div>';return;}
  const col={controlada:'var(--verde)',activa:'var(--naranja)',cronica:'var(--morado)',curada:'var(--gris)'};
  el.innerHTML='<div class="tag-wrap">'+D.enfermedades.map(e=>`
    <div class="tag" style="background:${col[e.estado]||'#aaa'}22;color:${col[e.estado]||'#555'}">
      ${e.nombre}${e.desde?' ('+e.desde+')':''}
      <span onclick="delItem('enfermedades',${e.id},renderEnfermedades)" style="margin-left:4px;opacity:.6;cursor:pointer">Ã—</span>
    </div>`).join('')+'</div>';
}
function guardarAlergia(){
  const n=document.getElementById('alNombre').value.trim();
  if(!n){toast('âš ï¸ IngresÃ¡ la alergia');return;}
  D.alergias.push({id:Date.now(),nombre:n,tipo:document.getElementById('alTipo').value,
    reaccion:document.getElementById('alRea').value,gravedad:document.getElementById('alGrav').value});
  save();closeMod('modalAlergia');clearF(['alNombre','alRea']);
  renderAlergias();toast('âœ… Alergia guardada');
}
function renderAlergias(){
  const el=document.getElementById('alergiasList');
  if(!D.alergias.length){el.innerHTML='<div class="empty"><div class="ei">âš ï¸</div><p>Sin alergias.</p></div>';return;}
  const gCol={leve:'#d97706',moderada:'var(--naranja)',grave:'var(--rojo)'};
  el.innerHTML=D.alergias.map(a=>`
    <div class="li">
      <div class="icon-box" style="background:${gCol[a.gravedad]||'#aaa'}22"><span style="font-size:19px">âš ï¸</span></div>
      <div class="lic">
        <div class="lin">${a.nombre}</div>
        <div class="lid">${a.tipo} â€¢ <span style="color:${gCol[a.gravedad]};font-weight:800">${a.gravedad}</span></div>
        ${a.reaccion?`<div class="lism">${a.reaccion}</div>`:''}
      </div>
      <button class="del-btn" onclick="delItem('alergias',${a.id},renderAlergias)">ğŸ—‘ï¸</button>
    </div>`).join('');
}
function guardarVacuna(){
  const n=document.getElementById('vacNombre').value;
  if(!n){toast('âš ï¸ SeleccionÃ¡ una vacuna');return;}
  D.vacunas.push({id:Date.now(),nombre:n,fecha:document.getElementById('vacFecha').value,
    prox:document.getElementById('vacProx').value,nota:document.getElementById('vacNota').value});
  save();closeMod('modalVacuna');clearF(['vacNota','vacProx']);
  document.getElementById('vacNombre').value='';
  renderVacunas();toast('âœ… Vacuna registrada');setTimeout(syncAlarmasNativas,300);
}
function renderVacunas(){
  const el=document.getElementById('vacunasList');
  if(!D.vacunas.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ’‰</div><p>Sin vacunas.</p></div>';return;}
  el.innerHTML=D.vacunas.map(v=>{
    const prox=v.prox?new Date(v.prox+'T00:00:00'):null;
    const proxStr=prox?prox.toLocaleDateString('es-AR'):'â€”';
    const vencida=prox&&prox<new Date();
    return `<div class="li">
      <div class="icon-box" style="background:${vencida?'var(--rojo-bg)':'var(--verde-bg)'}"><span style="font-size:18px">ğŸ’‰</span></div>
      <div class="lic">
        <div class="lin">${v.nombre}</div>
        ${v.fecha?`<div class="lid">ğŸ“… ${new Date(v.fecha+'T00:00:00').toLocaleDateString('es-AR')}</div>`:''}
        <div class="lism" style="${vencida?'color:var(--rojo);font-weight:800':''}">PrÃ³xima: ${proxStr}${vencida?' âš ï¸ Vencida':''}</div>
      </div>
      <button class="del-btn" onclick="delItem('vacunas',${v.id},renderVacunas)">ğŸ—‘ï¸</button>
    </div>`;
  }).join('');
}
function guardarDieta(){
  const a=document.getElementById('dAlimento').value.trim();
  if(!a){toast('âš ï¸ IngresÃ¡ el alimento');return;}
  D.dieta.push({id:Date.now(),alimento:a,tipo:document.getElementById('dTipo').value,
    motivo:document.getElementById('dMotivo').value});
  save();closeMod('modalDieta');clearF(['dAlimento','dMotivo']);
  renderDieta();toast('âœ… RestricciÃ³n guardada');
}
function renderDieta(){
  const el=document.getElementById('dietaList');
  if(!D.dieta.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ½ï¸</div><p>Sin restricciones.</p></div>';return;}
  const tc={prohibido:{dot:'var(--rojo)',label:'ğŸ”´ Prohibido'},reducir:{dot:'var(--naranja)',label:'ğŸŸ  Reducir'},recomendado:{dot:'var(--verde)',label:'ğŸŸ¢ Recomendado'}};
  el.innerHTML=D.dieta.map(d=>
    `<div class="diet-item">
      <div class="diet-dot" style="background:${tc[d.tipo]?.dot||'#aaa'}"></div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:800">${d.alimento}</div>
        <div style="font-size:11px;color:var(--gris)">${tc[d.tipo]?.label||d.tipo}${d.motivo?' â€¢ '+d.motivo:''}</div>
      </div>
      <button class="del-btn" onclick="delItem('dieta',${d.id},renderDieta)">ğŸ—‘ï¸</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACTIVIDAD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function guardarActividad(){
  const mins=parseInt(document.getElementById('actMins').value)||0;
  const pasos=parseInt(document.getElementById('actPasos').value)||0;
  if(!mins&&!pasos){toast('âš ï¸ IngresÃ¡ minutos o pasos');return;}
  D.actividades.push({id:Date.now(),
    fecha:new Date().toISOString().split('T')[0],
    tipo:document.getElementById('actTipo').value,
    mins,pasos,
    intensidad:document.getElementById('actIntensidad').value,
    sentido:document.getElementById('actSentido').value});
  save();closeMod('modalActividad');clearF(['actMins','actPasos','actSentido']);
  renderHome();toast('ğŸƒ Actividad guardada');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUEÃ‘O â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function guardarSueno(){
  const hD=document.getElementById('sHDormi').value;
  const hDes=document.getElementById('sHDesperte').value;
  if(!hD||!hDes){toast('âš ï¸ IngresÃ¡ los horarios');return;}
  const [h1,m1]=hD.split(':').map(Number);
  const [h2,m2]=hDes.split(':').map(Number);
  let mins=(h2*60+m2)-(h1*60+m1);
  if(mins<0)mins+=24*60;
  const horas=mins/60;
  const hoy=new Date().toISOString().split('T')[0];
  D.sueno=D.sueno.filter(s=>s.fecha!==hoy);
  D.sueno.unshift({id:Date.now(),fecha:hoy,horas,calidad:parseInt(document.getElementById('sCalidad').value),
    hDormi:hD,hDesperte:hDes,nota:document.getElementById('sNota').value});
  save();closeMod('modalSueno');clearF(['sNota']);
  renderHome();toast(`ğŸ˜´ ${horas.toFixed(1)}hs de sueÃ±o registradas`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NOTAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingNotaId=null;
function guardarNota(){
  const t=document.getElementById('nTitulo').value.trim();
  const c=document.getElementById('nContenido').value.trim();
  if(!c){toast('âš ï¸ IngresÃ¡ la nota');return;}
  if(editingNotaId){
    const n=D.notas.find(x=>x.id===editingNotaId);
    if(n){n.titulo=t||'Nota';n.contenido=c;n.fechaEdit=new Date().toISOString();}
    editingNotaId=null;
    document.querySelector('#modalNota .mt').textContent='ğŸ“ Nueva Nota';
  } else {
    D.notas.unshift({id:Date.now(),titulo:t||'Nota',contenido:c,fecha:new Date().toISOString()});
  }
  save();closeMod('modalNota');clearF(['nTitulo','nContenido']);
  renderNotas();toast('ğŸ“ Nota guardada');
}
function editNota(id){
  const n=D.notas.find(x=>x.id===id);if(!n)return;
  editingNotaId=id;
  document.getElementById('nTitulo').value=n.titulo||'';
  document.getElementById('nContenido').value=n.contenido||'';
  document.querySelector('#modalNota .mt').textContent='âœï¸ Editar Nota';
  openMod('modalNota');
}
function renderNotas(){
  const el=document.getElementById('notasList');
  if(!D.notas.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“</div><p>Sin notas.</p></div>';return;}
  el.innerHTML=D.notas.map(n=>{
    const f=new Date(n.fecha);
    return `<div class="li" style="align-items:flex-start">
      <div class="icon-box" style="background:var(--verde-bg)"><span>ğŸ“</span></div>
      <div class="lic">
        <div class="lin">${n.titulo}</div>
        <div class="lid" style="white-space:normal;line-height:1.4">${n.contenido}</div>
        <div class="lism">${f.toLocaleDateString('es-AR')}</div>
      </div>
      <button class="del-btn" style="color:var(--azul)" onclick="editNota(${n.id})">âœï¸</button>
      <button class="del-btn" onclick="delItem('notas',${n.id},renderNotas)">ğŸ—‘ï¸</button>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FOTOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function agregarFoto(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    const nombre=prompt('Nombre del documento (ej: Receta Dr. GarcÃ­a, AnÃ¡lisis Enero):','Documento');
    if(!nombre)return;
    D.fotos.unshift({id:Date.now(),nombre,data:ev.target.result,fecha:new Date().toISOString()});
    save();renderFotos();toast('ğŸ“¸ Foto guardada');
  };
  reader.readAsDataURL(file);
}
function renderFotos(){
  const el=document.getElementById('fotosList');
  if(!D.fotos.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“„</div><p>Sin fotos guardadas.</p></div>';return;}
  el.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">`+
    D.fotos.map(f=>`
    <div style="position:relative">
      <img src="${f.data}" style="width:100%;height:100px;object-fit:cover;border-radius:12px;cursor:pointer" onclick="verFoto('${f.id}')">
      <div style="font-size:11px;font-weight:700;color:var(--gris);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${f.nombre}</div>
      <button onclick="delItem('fotos',${f.id},renderFotos)" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,.5);border:none;color:#fff;border-radius:50%;width:22px;height:22px;font-size:12px;cursor:pointer">Ã—</button>
    </div>`).join('')+'</div>';
}
function verFoto(id){
  const f=D.fotos.find(x=>x.id==id);
  if(!f)return;
  const w=window.open('','_blank');
  w.document.write(`<html><body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;min-height:100vh"><img src="${f.data}" style="max-width:100%;max-height:100vh"></body></html>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COMPARTIR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function compartirResumen(){
  const p=D.perfil;
  let txt=`*MI RESUMEN DE SALUD*\n`;
  txt+=`Fecha: ${new Date().toLocaleDateString('es-AR')}\n\n`;
  if(p.nombre)txt+=`ğŸ‘¤ *Paciente:* ${p.nombre}\n`;
  if(p.nac)txt+=`ğŸ‚ Edad: ${calcEdad(p.nac)} aÃ±os\n`;
  if(p.sangre)txt+=`ğŸ©¸ Grupo sanguÃ­neo: ${p.sangre}\n`;
  if(p.obraSocial)txt+=`ğŸ¥ Obra social: ${p.obraSocial}${p.afiliado?' NÂº'+p.afiliado:''}\n`;
  txt+='\n';
  if(D.enfermedades.length)txt+=`ğŸ©º *Condiciones:* ${D.enfermedades.map(e=>e.nombre).join(', ')}\n`;
  if(D.alergias.length)txt+=`âš ï¸ *Alergias:* ${D.alergias.map(a=>a.nombre).join(', ')}\n`;
  if(D.medicamentos.length)txt+=`ğŸ’Š *Medicamentos:* ${D.medicamentos.map(m=>`${m.nombre} (${fmtH(m.hora)})`).join(', ')}\n`;
  if(D.vitales.length){
    const v=D.vitales[0];
    txt+='\nğŸ“Š *Ãšltimos signos vitales:*\n';
    if(v.pa)txt+=`  - PresiÃ³n: ${v.pa} mmHg\n`;
    if(v.fc)txt+=`  - Frecuencia: ${v.fc} lpm\n`;
    if(v.temp)txt+=`  - Temperatura: ${v.temp}Â°C\n`;
    if(v.so2)txt+=`  - SaturaciÃ³n Oâ‚‚: ${v.so2}%\n`;
    if(v.peso)txt+=`  - Peso: ${v.peso} kg\n`;
    if(v.glucosa)txt+=`  - Glucosa: ${v.glucosa} mg/dL\n`;
  }
  txt+='\n_Generado por Mi Salud App_';
  if(navigator.share){
    navigator.share({title:'Mi Resumen de Salud',text:txt}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(txt).then(()=>toast('ğŸ“‹ Resumen copiado al portapapeles'));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAPA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buscarCerca(tipo){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const url=`https://maps.google.com/?q=${tipo}+cerca&near=${pos.coords.latitude},${pos.coords.longitude}`;
      window.open(url,'_blank');
    },()=>{
      window.open(`https://maps.google.com/?q=${tipo}+cerca`,'_blank');
    });
  } else {
    window.open(`https://maps.google.com/?q=${tipo}+cerca`,'_blank');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LLAMADAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function llamar(n){if(confirm(`Â¿Llamar al ${n}?`))window.location.href='tel:'+n;}
function llamarContacto(){
  const c=D.perfil.contacto;
  if(!c){toast('âš ï¸ AgregÃ¡ un contacto de emergencia en Perfil');return;}
  const m=c.match(/[\d\-\s\+]+$/);
  if(m){llamar(m[0].trim());}
  else{toast('Contacto: '+c);}
}
function llamarMedico(){
  const t=D.perfil.telMed;
  if(!t){toast('âš ï¸ AgregÃ¡ el telÃ©fono del mÃ©dico en Perfil');return;}
  llamar(t);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SONIDO (Web Audio API) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx=null;
let selectedSound='suave';

function getAudioCtx(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}

function playSuave(){
  const ctx=getAudioCtx();
  // Melodia suave: tres notas ascendentes tipo campana
  const notas=[523,659,784,1047];
  notas.forEach((freq,i)=>{
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='sine';
    osc.frequency.setValueAtTime(freq,ctx.currentTime+i*0.35);
    gain.gain.setValueAtTime(0,ctx.currentTime+i*0.35);
    gain.gain.linearRampToValueAtTime(0.25,ctx.currentTime+i*0.35+0.05);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.35+0.5);
    osc.start(ctx.currentTime+i*0.35);
    osc.stop(ctx.currentTime+i*0.35+0.55);
  });
}

function playIntenso(){
  const ctx=getAudioCtx();
  // Alarma intensa: pitido repetido urgente
  for(let rep=0;rep<4;rep++){
    const startT=ctx.currentTime+rep*0.4;
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    const osc2=ctx.createOscillator();
    const gain2=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc2.connect(gain2);gain2.connect(ctx.destination);
    osc.type='square';osc.frequency.setValueAtTime(880,startT);
    gain.gain.setValueAtTime(0.4,startT);
    gain.gain.setValueAtTime(0.4,startT+0.15);
    gain.gain.linearRampToValueAtTime(0,startT+0.2);
    osc.start(startT);osc.stop(startT+0.22);
    osc2.type='square';osc2.frequency.setValueAtTime(1100,startT+0.05);
    gain2.gain.setValueAtTime(0,startT);
    gain2.gain.setValueAtTime(0.3,startT+0.05);
    gain2.gain.linearRampToValueAtTime(0,startT+0.2);
    osc2.start(startT+0.05);osc2.stop(startT+0.22);
  }
}

function playAlarmSound(){
  try{
    if(selectedSound==='intenso')playIntenso();
    else playSuave();
  }catch(e){console.log('Audio error:',e);}
}

function testSound(tipo){
  // En Android nativo usa el sistema de sonidos real
  if(window.AndroidBridge && window.AndroidBridge.probarSonido){
    window.AndroidBridge.probarSonido(tipo);
    toast(tipo==='intenso'?'ğŸ”” Probando sonido intenso...':'ğŸµ Probando sonido suave...');
    return;
  }
  try{
    if(tipo==='intenso')playIntenso();
    else playSuave();
    toast(tipo==='intenso'?'ğŸ”” Sonido intenso':'ğŸµ Sonido suave');
  }catch(e){toast('âš ï¸ ActivÃ¡ el audio en tu dispositivo');}
}

function selectSound(tipo){
  selectedSound=tipo;
  D.config=D.config||{};D.config.sound=tipo;save();
  ['suave','intenso'].forEach(t=>{
    const el=document.getElementById('sndOpt-'+t);
    if(!el)return;
    if(t===tipo){
      el.style.border='2.5px solid var(--verde)';
      el.style.background='var(--verde-bg)';
      el.querySelector('div:nth-child(2)').style.color='var(--verde)';
    } else {
      el.style.border='2.5px solid #e5e7eb';
      el.style.background='var(--gris-bg)';
      el.querySelector('div:nth-child(2)').style.color='var(--gris)';
    }
  });
  toast(tipo==='intenso'?'ğŸ”” Sonido intenso seleccionado':'ğŸµ Sonido suave seleccionado');
  // Notificar al sistema nativo Android
  if(window.AndroidBridge && window.AndroidBridge.setTipoSonido){
    window.AndroidBridge.setTipoSonido(tipo);
  }
}

function loadSoundConfig(){
  if(D.config&&D.config.sound){
    selectedSound=D.config.sound;
    selectSound(selectedSound);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALARMAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startAlarms(){
  setInterval(()=>{
    if(!document.getElementById('togMeds').classList.contains('on'))return;
    const now=new Date();
    const hh=String(now.getHours()).padStart(2,'0');
    const mm=String(now.getMinutes()).padStart(2,'0');
    const t=`${hh}:${mm}`;
    const hoy=now.toISOString().split('T')[0];
    D.medicamentos.forEach(m=>{
      if(m.hora===t&&!m.tomados[hoy]){
        document.getElementById('alarmTitle').textContent='ğŸ’Š '+m.nombre;
        document.getElementById('alarmSub').textContent=fmtH(m.hora)+(m.dosis?' â€” '+m.dosis:'');
        document.getElementById('alarmBanner').classList.add('show');
        playAlarmSound();
        if(navigator.vibrate)navigator.vibrate(selectedSound==='intenso'?[800,200,800,200,800]:[600,200,600]);
        setTimeout(()=>document.getElementById('alarmBanner').classList.remove('show'),30000);
      }
    });
    // Recordatorio agua
    if(document.getElementById('togAgua').classList.contains('on')){
      if(now.getHours()%2===0&&mm==='00'){
        const hoy2=now.toISOString().split('T')[0];
        if((D.water[hoy2]||0)<8){
          document.getElementById('alarmTitle').textContent='ğŸ’§ Hora de hidratarse';
          document.getElementById('alarmSub').textContent='Â¡No te olvides de tomar agua!';
          document.getElementById('alarmBanner').classList.add('show');
          playSuave();
          if(navigator.vibrate)navigator.vibrate([300]);
          setTimeout(()=>document.getElementById('alarmBanner').classList.remove('show'),8000);
        }
      }
    }
  },30000);
}
function closeAlarm(){document.getElementById('alarmBanner').classList.remove('show');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EXPORTAR / IMPORTAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarDatos(){
  try{
    const exportData={
      version:'8.0',
      exportDate:new Date().toISOString(),
      perfil:D.perfil,
      medicamentos:D.medicamentos,
      vitales:D.vitales,
      consultas:D.consultas,
      enfermedades:D.enfermedades,
      alergias:D.alergias,
      vacunas:D.vacunas,
      dieta:D.dieta,
      actividades:D.actividades,
      sueno:D.sueno,
      turnos:D.turnos,
      notas:D.notas,
      fotos:D.fotos,
      water:D.water,
      config:D.config||{}
    };
    const jsonStr=JSON.stringify(exportData,null,2);
    const fecha=new Date().toLocaleDateString('es-AR').split('/').join('-');
    const nombre='MiSalud_respaldo_'+fecha+'.json';
    const kb=Math.round(jsonStr.length/1024);

    // En Android nativo: guardar en Descargas y mostrar path
    if(window.AndroidBridge&&window.AndroidBridge.guardarRespaldo){
      const path=window.AndroidBridge.guardarRespaldo(jsonStr,nombre);
      if(path&&path.length>0){
        toast('âœ… Guardado en Descargas');
        mostrarEstadoImport(
          '<strong>âœ… Archivo guardado exitosamente</strong><br>'+
          '<span style="color:var(--gris)">ğŸ“ UbicaciÃ³n: <strong>'+path+'</strong></span><br>'+
          '<span style="color:var(--gris)">TamaÃ±o: '+kb+' KB</span>',
          'verde');
        return;
      }
    }
    // Fallback web: descarga normal
    const blob=new Blob([jsonStr],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=nombre;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast('âœ… Datos exportados ('+kb+' KB)');
    mostrarEstadoImport(
      'âœ… Archivo guardado: <strong>'+nombre+'</strong><br>'+
      '<span style="color:var(--gris)">TamaÃ±o: '+kb+' KB â€¢ Buscalo en tu carpeta Descargas</span>',
      'verde');
  }catch(e){
    toast('âŒ Error al exportar: '+e.message);
  }
}

function importarDatos(event){
  const file=event.target.files[0];
  if(!file){return;}

  // Reset input para permitir reimportar el mismo archivo
  event.target.value='';

  mostrarEstadoImport('<span style="color:var(--azul)">â³ Leyendo archivo...</span>','azul');

  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const raw=e.target.result;
      const importData=JSON.parse(raw);

      // Validar que sea un archivo de Mi Salud
      if(!importData.version||!importData.exportDate){
        mostrarEstadoImport('âŒ <strong>Archivo invÃ¡lido.</strong> Asegurate de importar un archivo exportado por esta app.','rojo');
        return;
      }

      // Contar registros
      const total=[
        importData.medicamentos?.length||0,
        importData.consultas?.length||0,
        importData.vitales?.length||0,
        importData.turnos?.length||0,
        importData.notas?.length||0,
        importData.vacunas?.length||0,
      ].reduce((a,b)=>a+b,0);

      const fechaExport=new Date(importData.exportDate).toLocaleDateString('es-AR');

      // Confirmar antes de sobrescribir
      const confirmar=confirm(
        `Â¿Restaurar datos del respaldo?

` +
        `ğŸ“… Fecha del respaldo: ${fechaExport}
` +
        `ğŸ“Š Registros encontrados: ${total}

` +
        `âš ï¸ ATENCIÃ“N: Esto reemplazarÃ¡ TODOS los datos actuales.
` +
        `Esta acciÃ³n no se puede deshacer.`
      );

      if(!confirmar){
        mostrarEstadoImport('','');
        return;
      }

      // Restaurar datos campo por campo (con fallback a array vacÃ­o)
      D.perfil       = importData.perfil       || {};
      D.medicamentos = importData.medicamentos  || [];
      D.vitales      = importData.vitales       || [];
      D.consultas    = importData.consultas     || [];
      D.enfermedades = importData.enfermedades  || [];
      D.alergias     = importData.alergias      || [];
      D.vacunas      = importData.vacunas       || [];
      D.dieta        = importData.dieta         || [];
      D.actividades  = importData.actividades   || [];
      D.sueno        = importData.sueno         || [];
      D.turnos       = importData.turnos        || [];
      D.notas        = importData.notas         || [];
      D.fotos        = importData.fotos         || [];
      D.water        = importData.water         || {};
      D.config       = importData.config        || {};

      save();

      // Re-renderizar todo
      renderHome();
      renderMeds();
      renderVitales();
      renderTurnos();
      renderConsultas();
      renderEnfermedades();
      renderAlergias();
      renderVacunas();
      renderDieta();
      renderNotas();
      renderFotos();
      renderPerfil();
      setTimeout(renderCharts,300);
      setTimeout(loadSoundConfig,300);

      mostrarEstadoImport(
        `âœ… <strong>Datos restaurados correctamente</strong><br>
         <span style="color:var(--gris)">
           Respaldo del ${fechaExport} â€¢
           ${importData.medicamentos?.length||0} medicamentos â€¢
           ${importData.consultas?.length||0} consultas â€¢
           ${importData.vitales?.length||0} mediciones
         </span>`,
        'verde'
      );
      toast('âœ… Datos importados correctamente');

    }catch(err){
      mostrarEstadoImport(
        `âŒ <strong>Error al leer el archivo.</strong><br>
         <span style="color:var(--gris)">Asegurate de que el archivo no estÃ© daÃ±ado.</span>`,
        'rojo'
      );
      console.error('Import error:',err);
    }
  };
  reader.onerror=function(){
    mostrarEstadoImport('âŒ No se pudo leer el archivo.','rojo');
  };
  reader.readAsText(file,'utf-8');
}

function mostrarEstadoImport(html,tipo){
  const el=document.getElementById('importStatus');
  if(!el)return;
  if(!html){el.style.display='none';el.innerHTML='';return;}
  const colores={verde:'var(--verde-bg)',rojo:'var(--rojo-bg)',azul:'var(--azul-bg)'};
  el.style.display='block';
  el.style.cssText=`display:block;padding:12px 14px;border-radius:12px;font-size:13px;line-height:1.6;background:${colores[tipo]||'var(--gris-bg)'}`;
  el.innerHTML=html;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CALENDARIO EN HISTORIA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let calYearHist=new Date().getFullYear(), calMonthHist=new Date().getMonth(), calSelDayHist=null;

function calNavMesHist(dir){
  calMonthHist+=dir;
  if(calMonthHist>11){calMonthHist=0;calYearHist++;}
  if(calMonthHist<0){calMonthHist=11;calYearHist--;}
  renderCalendarioHist();
}

function renderCalendarioHist(){
  const dowEl=document.getElementById('calDowHist');
  if(dowEl) dowEl.innerHTML=DIAS_DOW.map(d=>`<div class="cal-dow">${d}</div>`).join('');
  const lbl=document.getElementById('calMonthLabelHist');
  if(lbl) lbl.textContent=MESES[calMonthHist]+' '+calYearHist;
  const grid=document.getElementById('calGridHist');
  if(!grid) return;
  const events=getCalEvents();
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const primerDia=new Date(calYearHist,calMonthHist,1).getDay();
  const diasMes=new Date(calYearHist,calMonthHist+1,0).getDate();
  const diasMesAnt=new Date(calYearHist,calMonthHist,0).getDate();
  let html='';
  for(let i=primerDia-1;i>=0;i--) html+=`<div class="cal-cell other">${diasMesAnt-i}</div>`;
  for(let d=1;d<=diasMes;d++){
    const fecha=`${calYearHist}-${String(calMonthHist+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const esHoy=new Date(calYearHist,calMonthHist,d).getTime()===hoy.getTime();
    const esSel=calSelDayHist===fecha;
    const evs=events[fecha]||[];
    const tipos=[...new Set(evs.map(e=>e.tipo))];
    const dots=tipos.map(t=>`<div class="cal-dot ${esHoy?'cal-today-dot':''}" style="background:${CAL_COLORS[t]}"></div>`).join('');
    const cls=['cal-cell',esHoy?'today':'',esSel&&!esHoy?'selected':''].filter(Boolean).join(' ');
    html+=`<div class="${cls}" onclick="calSelectDayHist('${fecha}')">${d}${dots?`<div class="cal-dots">${dots}</div>`:''}</div>`;
  }
  const total=primerDia+diasMes;
  const resto=total%7===0?0:7-(total%7);
  for(let i=1;i<=resto;i++) html+=`<div class="cal-cell other">${i}</div>`;
  grid.innerHTML=html;
  renderCalProximosHist(events);
}

function calSelectDayHist(fecha){
  calSelDayHist=fecha;
  renderCalendarioHist();
  const events=getCalEvents();
  const evs=events[fecha]||[];
  const card=document.getElementById('calDiaCardHist');
  const lbl=document.getElementById('calDiaLabelHist');
  const lista=document.getElementById('calDiaEventosHist');
  if(!card||!lbl||!lista) return;
  const f=new Date(fecha+'T00:00:00');
  lbl.textContent='ğŸ“‹ '+f.toLocaleDateString('es-AR',{weekday:'long',day:'numeric',month:'long'});
  card.style.display='block';
  if(!evs.length){
    lista.innerHTML='<div style="color:var(--gris);font-size:13px;padding:8px 0">Sin eventos este dÃ­a</div>';
    return;
  }
  lista.innerHTML=evs.map(e=>`
    <div class="cal-ev" style="background:${e.color}11;border-left-color:${e.color}">
      <div style="font-size:20px">${e.icon}</div>
      <div>
        <div class="cal-ev-title">${e.title}</div>
        ${e.sub?`<div class="cal-ev-sub">${e.sub}</div>`:''}
      </div>
    </div>`).join('');
}

function renderCalProximosHist(events){
  const el=document.getElementById('calProximosHist');
  if(!el) return;
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const items=[];
  for(let d=0;d<=30;d++){
    const dd=new Date(hoy); dd.setDate(hoy.getDate()+d);
    const k=dd.toISOString().substring(0,10);
    const evs=(events[k]||[]).filter(e=>e.tipo!=='med');
    evs.forEach(e=>{
      const dias=d;
      const label=dias===0?'Hoy':dias===1?'MaÃ±ana':dias+' dÃ­as';
      const color=dias===0?'var(--rojo)':dias<=3?'var(--naranja)':'var(--azul)';
      items.push({dias,label,color,e,fecha:k});
    });
  }
  if(!items.length){
    el.innerHTML='<div class="empty"><div class="ei">ğŸ“…</div><p>Sin eventos prÃ³ximos</p></div>';
    return;
  }
  el.innerHTML=items.slice(0,15).map(it=>`
    <div class="prox-item">
      <div style="font-size:20px">${it.e.icon}</div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:800;color:var(--oscuro)">${it.e.title}</div>
        ${it.e.sub?`<div style="font-size:11px;color:var(--gris)">${it.e.sub}</div>`:''}
        <div style="font-size:10px;color:var(--gris2);margin-top:1px">${new Date(it.fecha+'T00:00:00').toLocaleDateString('es-AR')}</div>
      </div>
      <span class="prox-badge" style="background:${it.color}18;color:${it.color}">${it.label}</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function delItem(key,id,rfn){
  if(!confirm('Â¿Eliminar este registro?'))return;
  D[key]=D[key].filter(x=>x.id!==id);
  save();rfn();
  if(key==='medicamentos') syncAlarmasNativas();
}
function clearF(ids){ids.forEach(id=>{const e=document.getElementById(id);if(e)e.value=''});}
function toast(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),2500);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CALENDARIO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth(), calSelDay=null;
const CAL_COLORS={med:'var(--naranja)',turno:'var(--azul)',consulta:'var(--morado)',vacuna:'var(--verde)'};
const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIAS_DOW=['Dom','Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b'];

function calNavMes(dir){
  calMonth+=dir;
  if(calMonth>11){calMonth=0;calYear++;}
  if(calMonth<0){calMonth=11;calYear--;}
  renderCalendario();
}

function getCalEvents(){
  // Recopilar TODOS los eventos con fecha
  const events={};
  function addEv(dateStr,tipo,title,sub,icon){
    if(!dateStr)return;
    const k=dateStr.substring(0,10);
    if(!events[k])events[k]=[];
    events[k].push({tipo,title,sub,icon,color:CAL_COLORS[tipo]||'var(--gris)'});
  }
  // Medicamentos â†’ repetir cada dÃ­a
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  for(let d=0;d<60;d++){
    const dd=new Date(hoy); dd.setDate(hoy.getDate()+d);
    const k=dd.toISOString().substring(0,10);
    D.medicamentos.forEach(m=>{
      const freq=m.freq||'diario';
      let incluir=false;
      if(freq==='diario'||freq==='manana'||freq==='noche'||freq==='c8h'||freq==='c12h') incluir=true;
      else if(freq==='semanal' && d%7===0) incluir=true;
      if(incluir) addEv(k,'med','ğŸ’Š '+m.nombre,fmtH(m.hora)+(m.dosis?' â€” '+m.dosis:''),'ğŸ’Š');
    });
  }
  // Turnos
  D.turnos.forEach(t=>addEv(t.fecha,'turno','ğŸ“… '+t.esp,(t.hora?fmtH(t.hora)+' ':'')+(t.lugar||''),'ğŸ“…'));
  // Consultas
  D.consultas.forEach(c=>{
    addEv(c.fecha,'consulta','ğŸ¥ '+c.esp,c.medico||'','ğŸ¥');
    if(c.prox) addEv(c.prox,'turno','ğŸ“… PrÃ³ximo turno: '+c.esp,c.medico||'','ğŸ“…');
  });
  // Vacunas prÃ³ximas dosis
  D.vacunas.forEach(v=>{if(v.prox) addEv(v.prox,'vacuna','ğŸ’‰ Vacuna: '+(v.nombre||v.vacuna||''),'PrÃ³xima dosis','ğŸ’‰');});
  return events;
}

function renderCalendario(){
  // Header dÃ­as semana
  const dowEl=document.getElementById('calDow');
  if(dowEl) dowEl.innerHTML=DIAS_DOW.map(d=>`<div class="cal-dow">${d}</div>`).join('');

  // Label mes
  const lbl=document.getElementById('calMonthLabel');
  if(lbl) lbl.textContent=MESES[calMonth]+' '+calYear;

  const grid=document.getElementById('calGrid');
  if(!grid) return;

  const events=getCalEvents();
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const primerDia=new Date(calYear,calMonth,1).getDay();
  const diasMes=new Date(calYear,calMonth+1,0).getDate();
  const diasMesAnt=new Date(calYear,calMonth,0).getDate();

  let html='';
  // DÃ­as mes anterior
  for(let i=primerDia-1;i>=0;i--){
    html+=`<div class="cal-cell other">${diasMesAnt-i}</div>`;
  }
  // DÃ­as del mes
  for(let d=1;d<=diasMes;d++){
    const fecha=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const esHoy=new Date(calYear,calMonth,d).getTime()===hoy.getTime();
    const esSel=calSelDay===fecha;
    const evs=events[fecha]||[];
    const tipos=[...new Set(evs.map(e=>e.tipo))];
    const dots=tipos.map(t=>`<div class="cal-dot ${esHoy?'cal-today-dot':''}" style="background:${CAL_COLORS[t]}"></div>`).join('');
    const cls=['cal-cell', esHoy?'today':'', esSel&&!esHoy?'selected':''].filter(Boolean).join(' ');
    html+=`<div class="${cls}" onclick="calSelectDay('${fecha}')">${d}${dots?`<div class="cal-dots">${dots}</div>`:''}</div>`;
  }
  // Completar Ãºltima fila
  const total=primerDia+diasMes;
  const resto=total%7===0?0:7-(total%7);
  for(let i=1;i<=resto;i++) html+=`<div class="cal-cell other">${i}</div>`;

  grid.innerHTML=html;
  renderCalProximos(events);
}

function calSelectDay(fecha){
  calSelDay=fecha;
  renderCalendario();
  const events=getCalEvents();
  const evs=events[fecha]||[];
  const card=document.getElementById('calDiaCard');
  const lbl=document.getElementById('calDiaLabel');
  const lista=document.getElementById('calDiaEventos');
  if(!card||!lbl||!lista) return;

  const f=new Date(fecha+'T00:00:00');
  lbl.textContent='ğŸ“‹ '+f.toLocaleDateString('es-AR',{weekday:'long',day:'numeric',month:'long'});

  if(!evs.length){
    card.style.display='block';
    lista.innerHTML='<div style="color:var(--gris);font-size:13px;padding:8px 0">Sin eventos este dÃ­a</div>';
    return;
  }
  card.style.display='block';
  lista.innerHTML=evs.map(e=>`
    <div class="cal-ev" style="background:${e.color}11;border-left-color:${e.color}">
      <div style="font-size:20px">${e.icon}</div>
      <div>
        <div class="cal-ev-title">${e.title}</div>
        ${e.sub?`<div class="cal-ev-sub">${e.sub}</div>`:''}
      </div>
    </div>`).join('');
}

function renderCalProximos(events){
  const el=document.getElementById('calProximos');
  if(!el) return;
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const items=[];
  for(let d=0;d<=30;d++){
    const dd=new Date(hoy); dd.setDate(hoy.getDate()+d);
    const k=dd.toISOString().substring(0,10);
    const evs=(events[k]||[]).filter(e=>e.tipo!=='med'); // excluir medicamentos del listado
    evs.forEach(e=>{
      const dias=d;
      const label=dias===0?'Hoy':dias===1?'MaÃ±ana':dias+' dÃ­as';
      const color=dias===0?'var(--rojo)':dias<=3?'var(--naranja)':'var(--azul)';
      items.push({dias,label,color,e,fecha:k});
    });
  }
  if(!items.length){
    el.innerHTML='<div class="empty"><div class="ei">ğŸ“…</div><p>Sin eventos en los prÃ³ximos 30 dÃ­as</p></div>';
    return;
  }
  el.innerHTML=items.slice(0,15).map(it=>`
    <div class="prox-item">
      <div style="font-size:20px">${it.e.icon}</div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:800;color:var(--oscuro)">${it.e.title}</div>
        ${it.e.sub?`<div style="font-size:11px;color:var(--gris)">${it.e.sub}</div>`:''}
        <div style="font-size:10px;color:var(--gris2);margin-top:1px">${new Date(it.fecha+'T00:00:00').toLocaleDateString('es-AR')}</div>
      </div>
      <span class="prox-badge" style="background:${it.color}18;color:${it.color}">${it.label}</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NOTIFICACIONES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function crearNotif(tipo, titulo, cuerpo, icono, color){
  const n={
    id:Date.now()+Math.random(),
    tipo,titulo,cuerpo,icono:icono||'ğŸ””',color:color||'var(--azul-bg)',
    fecha:new Date().toISOString(),
    leida:false
  };
  if(!D.notifs) D.notifs=[];
  // Evitar duplicados del mismo dÃ­a mismo tÃ­tulo
  const k=titulo+'_'+new Date().toISOString().substring(0,10);
  if(D.notifs.some(x=>x._key===k)) return;
  n._key=k;
  D.notifs.unshift(n);
  if(D.notifs.length>100) D.notifs=D.notifs.slice(0,100);
  save();
  actualizarBadgeNotifs();
  // NotificaciÃ³n nativa Android
  if(window.AndroidBridge&&window.AndroidBridge.mostrarNotificacion){
    try{window.AndroidBridge.mostrarNotificacion(titulo,cuerpo,tipo);}catch(e){}
  }
}

function generarNotificacionesProgramadas(){
  if(!D.notifs) D.notifs=[];
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const manana=new Date(hoy); manana.setDate(hoy.getDate()+1);
  const en3dias=new Date(hoy); en3dias.setDate(hoy.getDate()+3);
  const en7dias=new Date(hoy); en7dias.setDate(hoy.getDate()+7);

  // Turnos: avisar hoy si el turno es maÃ±ana o en 3 dÃ­as
  D.turnos.forEach(t=>{
    const ft=new Date(t.fecha+'T00:00:00');
    if(ft.getTime()===manana.getTime())
      crearNotif('turno','ğŸ“… Turno maÃ±ana','Tu turno de '+t.esp+' es maÃ±ana'+(t.hora?' a las '+fmtH(t.hora):'')+(t.lugar?' en '+t.lugar:''),'ğŸ“…','var(--azul-bg)');
    if(ft.getTime()===en3dias.getTime())
      crearNotif('turno','ğŸ“… Turno en 3 dÃ­as','RecordÃ¡: '+t.esp+' el '+ft.toLocaleDateString('es-AR'),'ğŸ“…','var(--azul-bg)');
  });

  // Consultas: avisar si hay prÃ³ximo turno pronto
  D.consultas.forEach(cc=>{
    if(!cc.prox) return;
    const fp=new Date(cc.prox+'T00:00:00');
    if(fp.getTime()===manana.getTime())
      crearNotif('consulta','ğŸ¥ Consulta maÃ±ana','PrÃ³xima consulta con '+cc.esp+(cc.medico?' â€” '+cc.medico:''),'ğŸ¥','var(--morado-bg)');
  });

  // Vacunas: avisar si vence pronto
  D.vacunas.forEach(v=>{
    if(!v.prox) return;
    const fv=new Date(v.prox+'T00:00:00');
    const nombre=v.nombre||v.vacuna||'vacuna';
    if(fv.getTime()===en7dias.getTime())
      crearNotif('vacuna','ğŸ’‰ Vacuna en 7 dÃ­as','PrÃ³xima dosis de '+nombre+' el '+fv.toLocaleDateString('es-AR'),'ğŸ’‰','var(--verde-bg)');
    if(fv<=hoy && fv.getTime()!==hoy.getTime()-86400000)
      crearNotif('vacuna','ğŸ’‰ Vacuna vencida','La dosis de '+nombre+' ya venciÃ³. ConsultÃ¡ con tu mÃ©dico','ğŸ’‰','var(--rojo-bg)');
  });

  // Medicamentos: avisar si hay alguno pendiente hoy
  const fechaHoy=hoy.toISOString().substring(0,10);
  const pendientes=D.medicamentos.filter(m=>!m.tomados||!m.tomados[fechaHoy]);
  if(pendientes.length>0){
    const hora=new Date().getHours();
    if(hora>=20){
      crearNotif('med','ğŸ’Š Medicamentos pendientes',pendientes.length+' medicamento(s) sin registrar hoy: '+pendientes.slice(0,3).map(m=>m.nombre).join(', '),'ğŸ’Š','var(--naranja-bg)');
    }
  }
}

function renderNotifs(){
  const el=document.getElementById('notifsContainer');
  if(!el) return;
  if(!D.notifs||!D.notifs.length){
    el.innerHTML='<div class="empty"><div class="ei">ğŸ””</div><p>Sin notificaciones todavÃ­a.</p></div>';
    return;
  }
  const sub=document.getElementById('notifsSubtitle');
  const noLeidas=D.notifs.filter(n=>!n.leida).length;
  if(sub) sub.textContent=noLeidas>0?noLeidas+' avisos sin leer':'Todo al dÃ­a âœ“';
  el.innerHTML=D.notifs.map(n=>`
    <div class="notif-item ${n.leida?'read':'unread'}">
      <div class="notif-icon-box" style="background:${n.color}">${n.icono}</div>
      <div style="flex:1">
        <div class="notif-title">${n.titulo}</div>
        <div class="notif-body">${n.cuerpo}</div>
        <div class="notif-time">${fmtNotifTime(n.fecha)}</div>
      </div>
      ${!n.leida?'<div class="unread-indicator"></div>':''}
    </div>`).join('');
}

function fmtNotifTime(iso){
  if(!iso) return '';
  const d=new Date(iso);
  const ahora=new Date();
  const diff=Math.floor((ahora-d)/60000);
  if(diff<1) return 'Ahora mismo';
  if(diff<60) return diff+' min';
  if(diff<1440) return Math.floor(diff/60)+'h';
  return d.toLocaleDateString('es-AR');
}

function marcarTodasLeidas(){
  if(!D.notifs) return;
  D.notifs.forEach(n=>n.leida=true);
  save();
  actualizarBadgeNotifs();
  renderNotifs();
}

function actualizarBadgeNotifs(){
  const badge=document.getElementById('notifBadge');
  if(!badge) return;
  const n=(D.notifs||[]).filter(x=>!x.leida).length;
  if(n>0){badge.textContent=n>9?'9+':n;badge.style.display='block';}
  else badge.style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VERIFICAR ACTUALIZACIONES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ datos de la versiÃ³n remota guardados al detectar update â”€â”€â”€
let _updateData = null;

async function checkUpdate(){
  try{
    const resp = await fetch(VERSION_JSON_URL, {cache:'no-store'});
    if(!resp.ok) return;
    const data = await resp.json();
    const remota = (data.version||'').trim();
    if(!remota || remota === APP_VERSION) return;
    // Comparar numÃ©ricamente
    const partsR = remota.split('.').map(Number);
    const partsA = APP_VERSION.split('.').map(Number);
    let hayNueva = false;
    for(let i=0; i<Math.max(partsR.length,partsA.length); i++){
      const vR = partsR[i]||0, vA = partsA[i]||0;
      if(vR>vA){hayNueva=true;break;}
      if(vR<vA) break;
    }
    if(!hayNueva) return;
    // No mostrar si ya fue instalada
    const yaInstalada = localStorage.getItem('updateInstalada_v');
    if(yaInstalada === remota) return;
    // Guardar datos ANTES de mostrar â€” asÃ­ estÃ¡n disponibles al tocar Ver
    _updateData = data;
    mostrarUpdateBanner(data);
    crearNotif('update','ğŸ”„ ActualizaciÃ³n v'+remota+' disponible',
      (data.cambios||[]).slice(0,2).join(' â€¢ '),'ğŸ”„','var(--azul-bg)');
  }catch(e){/* sin internet â€” ok */}
}

function mostrarUpdateBanner(data){
  const banner = document.getElementById('updateBanner');
  const title  = document.getElementById('updateBannerTitle');
  const sub    = document.getElementById('updateBannerSub');
  if(title) title.textContent = 'âœ¨ VersiÃ³n '+(data.version||'')+' disponible';
  if(sub)   sub.textContent   = 'TocÃ¡ aquÃ­ para actualizar â†’';
  if(banner){
    banner.style.display='';
    banner.classList.add('show');
    document.body.style.paddingTop='52px';
  }
}

function cerrarUpdateBanner(){
  const banner = document.getElementById('updateBanner');
  if(banner){ banner.classList.remove('show'); document.body.style.paddingTop='0'; }
}

async function abrirModalUpdate(){
  // Si _updateData no cargÃ³ todavÃ­a, reintentamos el fetch
  if(!_updateData){
    try{
      const resp = await fetch(VERSION_JSON_URL, {cache:'no-store'});
      if(resp.ok){
        const data = await resp.json();
        _updateData = data;
      }
    }catch(e){}
  }
  if(_updateData) renderModalUpdate(_updateData);
  openMod('modalUpdate');
}

function renderModalUpdate(data){
  const ver   = document.getElementById('umVersion');
  const lista = document.getElementById('umCambios');
  const apkBtn= document.getElementById('umBtnActualizar');
  if(ver)   ver.textContent = 'VersiÃ³n '+data.version;
  if(lista && data.cambios){
    lista.innerHTML = data.cambios.map(item=>
      '<li><span class="um-check">âœ…</span><span>'+item+'</span></li>'
    ).join('');
  }
  if(apkBtn && data.apk_url){
    apkBtn.style.display='block';
    apkBtn.dataset.url = data.apk_url;
  } else if(apkBtn){
    apkBtn.style.display='none';
  }
  // Reset progress
  const prog = document.getElementById('umProgress');
  const status= document.getElementById('umStatus');
  const instBtn=document.getElementById('umBtnInstalar');
  if(prog){ prog.style.display='none'; prog.querySelector('.um-fill').style.width='0%'; }
  if(status) status.textContent='';
  if(instBtn) instBtn.style.display='none';
}

function posponerUpdate(){
  closeMod('modalUpdate');
}

// Llamado desde botÃ³n "Actualizar ahora"
function iniciarDescargaAPK(){
  const btn = document.getElementById('umBtnActualizar');
  const url = btn ? btn.dataset.url : '';
  if(!url){ toast('âŒ No se encontrÃ³ el link de descarga'); return; }
  if(!window.AndroidBridge||!window.AndroidBridge.descargarAPK){
    toast('Solo disponible en la app Android');
    return;
  }
  // UI: mostrar progreso
  btn.disabled = true;
  btn.textContent = 'â³ Descargando...';
  const prog = document.getElementById('umProgress');
  const status= document.getElementById('umStatus');
  if(prog) prog.style.display='block';
  if(status) status.textContent = 'Iniciando descarga...';
  window.AndroidBridge.descargarAPK(url);
}

// Callbacks desde Java
function onApkProgreso(pct){
  const fill  = document.querySelector('#umProgress .um-fill');
  const status= document.getElementById('umStatus');
  if(fill)  fill.style.width = pct+'%';
  if(status)status.textContent = 'Descargando... '+pct+'%';
  if(pct>=100){
    if(status) status.textContent = 'âœ… Descarga completa. Instalando...';
  }
}

function onApkDescargado(path){
  const status = document.getElementById('umStatus');
  const instBtn= document.getElementById('umBtnInstalar');
  const descBtn= document.getElementById('umBtnActualizar');
  if(status) status.textContent = 'âœ… Descarga lista. TocÃ¡ Instalar para continuar.';
  if(instBtn){ instBtn.style.display='block'; instBtn.dataset.path=path; }
  if(descBtn){ descBtn.style.display='none'; }
}

function instalarAPK(){
  const btn = document.getElementById('umBtnInstalar');
  const path= btn ? btn.dataset.path : '';
  if(window.AndroidBridge&&window.AndroidBridge.instalarAPK){
    // Marcar como instalada para no volver a mostrar si algo falla antes de reiniciar
    if(_updateData) localStorage.setItem('updateInstalada_v', _updateData.version||'');
    window.AndroidBridge.instalarAPK(path);
  }
}

function onApkError(msg){
  const status= document.getElementById('umStatus');
  const descBtn=document.getElementById('umBtnActualizar');
  if(status) status.textContent = 'âŒ '+msg;
  if(descBtn){ descBtn.disabled=false; descBtn.textContent='ğŸ”„ Reintentar'; }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SYNC ALARMAS NATIVAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function abrirImportarArchivo(){
  // En Android nativo: usar bridge que configura el selector para JSON
  if(window.AndroidBridge&&window.AndroidBridge.abrirSelectorJson){
    window.AndroidBridge.abrirSelectorJson();
  } else {
    // Fallback web
    document.getElementById('importInput').click();
  }
}

function syncAlarmasNativas(){
  if(!window.AndroidBridge) return;
  try{
    // Usar mÃ©todo unificado si estÃ¡ disponible (v8+)
    if(window.AndroidBridge.sincronizarTodo){
      window.AndroidBridge.sincronizarTodo(
        JSON.stringify(D.medicamentos||[]),
        JSON.stringify(D.turnos||[]),
        JSON.stringify(D.consultas||[]),
        JSON.stringify(D.vacunas||[])
      );
      return;
    }
    // Fallback individual
    if(window.AndroidBridge.actualizarAlarmas)
      window.AndroidBridge.actualizarAlarmas(JSON.stringify(D.medicamentos||[]));
    if(window.AndroidBridge.actualizarTurnos)
      window.AndroidBridge.actualizarTurnos(JSON.stringify(D.turnos||[]));
    if(window.AndroidBridge.actualizarConsultas)
      window.AndroidBridge.actualizarConsultas(JSON.stringify(D.consultas||[]));
    if(window.AndroidBridge.actualizarVacunas)
      window.AndroidBridge.actualizarVacunas(JSON.stringify(D.vacunas||[]));
  }catch(e){console.log('Bridge error:',e);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',()=>{
  load();
  initDate();
  initPin();
  renderHome();
  renderMeds();
  renderVitales();
  renderTurnos();
  renderConsultas();
  renderEnfermedades();
  renderAlergias();
  renderVacunas();
  renderDieta();
  renderNotas();
  renderFotos();
  renderPerfil();
  setTimeout(renderCharts,500);
  startAlarms();
  setTimeout(loadSoundConfig,200);
  setTimeout(syncAlarmasNativas,1000);
  // Notificaciones e inicializaciÃ³n
  if(!D.notifs)D.notifs=[];
  if(!D.config)D.config={};
  setTimeout(()=>{
    generarNotificacionesProgramadas();
    actualizarBadgeNotifs();
    checkUpdate();
  },1500);
});
</script>

<!-- MODAL ACTUALIZACIÃ“N -->

<!-- MODAL ACTUALIZACIÃ“N v9 -->
<div class="mo" id="modalUpdate">
  <div class="modal">
    <div class="mh"></div>
    <div style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);border-radius:16px;padding:18px 16px;margin-bottom:16px;color:#fff;text-align:center">
      <div style="font-size:38px;margin-bottom:6px">âœ¨</div>
      <div style="font-size:17px;font-weight:900" id="umVersion">Nueva versiÃ³n disponible</div>
      <div style="font-size:12px;opacity:.85;margin-top:3px">Tus datos se conservan al actualizar</div>
    </div>
    <div style="font-size:13px;font-weight:800;color:var(--oscuro);margin-bottom:8px">ğŸ†• Novedades de esta versiÃ³n</div>
    <ul id="umCambios" style="list-style:none;padding:0;margin:0 0 14px 0"></ul>
    <div id="umProgress" style="display:none;margin-bottom:10px">
      <div style="background:#e5e7eb;border-radius:20px;height:10px;overflow:hidden">
        <div class="um-fill" style="height:100%;background:linear-gradient(90deg,var(--verde),var(--verde2));border-radius:20px;width:0%;transition:width .3s ease"></div>
      </div>
    </div>
    <div id="umStatus" style="font-size:12px;color:var(--gris);margin-bottom:10px;text-align:center;font-weight:700;min-height:18px"></div>
    <button id="umBtnActualizar" class="btn" style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff;font-size:15px;font-weight:900;padding:14px;width:100%;margin-bottom:8px;border-radius:14px;border:none;cursor:pointer" onclick="iniciarDescargaAPK()">â¬‡ï¸ Actualizar ahora</button>
    <button id="umBtnInstalar" class="btn" style="display:none;background:linear-gradient(135deg,var(--verde),var(--verde2));color:#fff;font-size:15px;font-weight:900;padding:14px;width:100%;margin-bottom:8px;border-radius:14px;border:none;cursor:pointer" onclick="instalarAPK()">ğŸ“² Instalar actualizaciÃ³n</button>
    <button class="btn" style="background:var(--gris-bg);color:var(--gris);font-size:13px;width:100%" onclick="posponerUpdate()">MÃ¡s tarde</button>
  </div>
</div>

</body>
</html>
